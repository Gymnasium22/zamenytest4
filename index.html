<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Гимназия №22: Управление v8.7</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22Gymnasium%20Manager%20Pro%22%2C%22short_name%22%3A%22Gymnasium%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%234f46e5%22%2C%22icons%22%3A%5B%5D%7D' />
    <meta name="theme-color" content="#4f46e5" />
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            fontFamily: { sans: ['Manrope', 'sans-serif'] },
            colors: {
              primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
              dark: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
            },
            animation: {
                'spin-slow': 'spin 3s linear infinite',
            }
          }
        }
      }
    </script>

    <!-- DEPENDENCIES (UMD) -->
    <!-- React 18 -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- React Router v6.3.0 -->
    <script crossorigin src="https://unpkg.com/history@5.3.0/umd/history.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router@6.3.0/umd/react-router.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-router-dom@6.3.0/umd/react-router-dom.production.min.js"></script>
    
    <!-- Utils -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body { font-family: 'Manrope', sans-serif; overscroll-behavior-y: none; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
      ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
      .dark ::-webkit-scrollbar-thumb { background: #475569; }
      .dark ::-webkit-scrollbar-thumb:hover { background: #64748b; }
      .hide-scrollbar::-webkit-scrollbar { display: none; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
      .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
      /* Context Menu Animation */
      .context-menu { animation: fadeIn 0.1s ease-out forwards; }
      
      /* Drag and Drop Styles */
      .dragging { opacity: 0.5; transform: scale(0.95); }
      .drag-over { background-color: rgba(99, 102, 241, 0.1) !important; box-shadow: inset 0 0 0 2px #6366f1; }

      @media print {
        @page { margin: 0.5cm; }
        .no-print { display: none !important; }
        body { background: white; color: black; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        .print-container { display: block !important; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: white; }
        .dark { background-color: white !important; color: black !important; }
        .dark * { background-color: white !important; color: black !important; border-color: #e2e8f0 !important; }
      }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-dark-950 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, createContext, useContext, useCallback } = React;
        
        const RRDOM = window.ReactRouterDOM;
        const { HashRouter, Routes, Route, Navigate, Outlet, NavLink, useNavigate, useLocation } = RRDOM;

        // --- ICONS ---
        const Icons = {
            Home: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Calendar: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
            Repeat: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>,
            Book: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/></svg>,
            Briefcase: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>,
            Download: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Menu: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>,
            GraduationCap: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>,
            X: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>,
            Plus: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
            Trash2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
            User: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Filter: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            Users: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            BookOpen: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Edit2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>,
            AlertTriangle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>,
            Search: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
            Image: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>,
            BarChart2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>,
            Copy: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>,
            CheckCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
            UserX: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="18" y1="8" x2="23" y2="13"/><line x1="23" y1="8" x2="18" y2="13"/></svg>,
            ArrowRight: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>,
            Star: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>,
            GripVertical: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="9" cy="5" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="19" r="1"/></svg>,
            Moon: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sun: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            FileSpreadsheet: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>,
            Upload: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
            Activity: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>,
            TrendingUp: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg>,
            Clipboard: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><rect x="8" y="2" width="8" height="4" rx="1" ry="1"/></svg>,
            Share2: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>,
            Eye: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
            Clock: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            MapPin: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>,
            AlertCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            MessageCircle: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>,
            Printer: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
            Bell: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
            DoorOpen: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 4h3a2 2 0 0 1 2 2v14"/><path d="M2 20h3"/><path d="M13 20h9"/><path d="M10 20v-6a2 2 0 0 1 2-2h1v1"/><path d="M13 12h1"/><path d="M5 20v-6a2 2 0 0 1 2-2h1v1"/><path d="M8 12h1"/><path d="M4 20v-8a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v8"/></svg>,
            SunMoon: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 0 1 1-9-9Z"/></svg>,
            RotateCcw: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>,
            RotateCw: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>,
            Loader: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            History: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>,
            Table: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-7z"/><path d="M3 9h18"/><path d="M12 21V9"/></svg>,
            Gift: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 12 20 22 4 22 4 12"/><rect x="2" y="7" width="20" height="5"/><line x1="12" y1="22" x2="12" y2="7"/><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z"/></svg>,
            AlertOctagon: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="7.86 2 16.14 2 22 7.86 22 16.14 16.14 22 7.86 22 2 16.14 2 7.86 7.86 2"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>,
            CheckSquare: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>,
            Box: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>,
            ChevronLeft: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            ChevronRight: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>,
            Send: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>,
            PieChart: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>,
            Settings: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Info: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>,
            Save: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
            List: (p) => <svg {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
        };
        
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const Comp = Icons[name] || Icons.AlertCircle;
            return <Comp width={size} height={size} className={className} {...props} />;
        };

        const DayOfWeek = { Monday: 'Пн', Tuesday: 'Вт', Wednesday: 'Ср', Thursday: 'Чт', Friday: 'Пт' };
        const Shift = { First: '1 смена', Second: '2 смена' };
        const DAYS = [DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday];
        const SHIFT_PERIODS = { [Shift.First]: [1, 2, 3, 4, 5, 6, 7], [Shift.Second]: [0, 1, 2, 3, 4, 5, 6] };
        const ROOM_TYPES = ['Обычный', 'Спортзал', 'Химия/Биология', 'Физика', 'Информатика', 'Музыка', 'Технология', 'Актовый зал'];
        
        const DEFAULT_BELLS = [
            { shift: Shift.First, period: 1, start: "08:00", end: "08:45", day: "default" },
            { shift: Shift.First, period: 2, start: "08:55", end: "09:40", day: "default" },
            { shift: Shift.First, period: 3, start: "09:50", end: "10:35", day: "default" },
            { shift: Shift.First, period: 4, start: "10:55", end: "11:40", day: "default" },
            { shift: Shift.First, period: 5, start: "11:50", end: "12:35", day: "default" },
            { shift: Shift.First, period: 6, start: "12:40", end: "13:25", day: "default" },
            { shift: Shift.First, period: 7, start: "13:30", end: "14:15", day: "default" },
            { shift: Shift.Second, period: 0, start: "13:30", end: "14:15", day: "default" },
            { shift: Shift.Second, period: 1, start: "14:20", end: "15:05", day: "default" },
            { shift: Shift.Second, period: 2, start: "15:15", end: "16:00", day: "default" },
            { shift: Shift.Second, period: 3, start: "16:10", end: "16:55", day: "default" },
            { shift: Shift.Second, period: 4, start: "17:05", end: "17:50", day: "default" },
            { shift: Shift.Second, period: 5, start: "18:00", end: "18:45", day: "default" },
            { shift: Shift.Second, period: 6, start: "18:50", end: "19:35", day: "default" }
        ];

        const INITIAL_DATA = {
            subjects: [
                { id: 's1', name: 'Математика', color: '#e0e7ff', difficulty: 11, requiredRoomType: 'Обычный' },
                { id: 's2', name: 'Русский язык', color: '#dcfce7', difficulty: 10, requiredRoomType: 'Обычный' },
                { id: 's3', name: 'Литература', color: '#fef9c3', difficulty: 5, requiredRoomType: 'Обычный' },
                { id: 's4', name: 'Физика', color: '#f3e8ff', difficulty: 12, requiredRoomType: 'Физика' },
                { id: 's5', name: 'История', color: '#ffedd5', difficulty: 6, requiredRoomType: 'Обычный' },
                { id: 's6', name: 'Информатика', color: '#cffafe', difficulty: 9, requiredRoomType: 'Информатика' },
            ],
            teachers: [
                { id: 't1', name: 'Иванова Анна Сергеевна', subjectIds: ['s1', 's4'], unavailableDates: [], absenceReasons: {}, shifts: [Shift.First, Shift.Second], birthDate: '1985-05-20', telegramChatId: '' },
                { id: 't2', name: 'Петров Борис Михайлович', subjectIds: ['s2', 's3'], unavailableDates: [], absenceReasons: {}, shifts: [Shift.First], birthDate: '1978-10-12', telegramChatId: '' },
            ],
            classes: [
                { id: 'c1', name: '5А', shift: Shift.First, studentsCount: 25 },
                { id: 'c2', name: '5Б', shift: Shift.First, studentsCount: 28 },
                { id: 'c3', name: '6А', shift: Shift.Second, studentsCount: 30 },
            ],
            rooms: [
                { id: 'r1', name: '101', capacity: 30, type: 'Обычный' },
                { id: 'r2', name: '102', capacity: 25, type: 'Обычный' },
                { id: 'r3', name: '201 (Физ)', capacity: 30, type: 'Физика' },
                { id: 'r4', name: '301 (Инф)', capacity: 15, type: 'Информатика' },
            ],
            schedule: [],
            substitutions: [],
            bellSchedule: DEFAULT_BELLS,
            settings: { telegramToken: '' }
        };

        const DB_NAME = 'GymnasiumDB';
        const DB_VERSION = 3; 
        const STORE_NAME = 'appData';
        const KEY = 'root';

        const dbService = {
            open: () => new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME); };
                request.onsuccess = (e) => resolve(e.target.result);
                request.onerror = (e) => reject(e.target.error);
            }),
            save: async (data) => {
                const db = await dbService.open();
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORE_NAME, 'readwrite');
                    transaction.objectStore(STORE_NAME).put(data, KEY);
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
            },
            load: async () => {
                const db = await dbService.open();
                return new Promise((resolve, reject) => {
                    const request = db.transaction(STORE_NAME, 'readonly').objectStore(STORE_NAME).get(KEY);
                    request.onsuccess = () => resolve(request.result || INITIAL_DATA);
                    request.onerror = () => reject(request.error);
                });
            },
            exportJson: (data) => {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url; link.download = `gymnasium_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            }
        };

        const DataContext = createContext();
        const DataProvider = ({ children }) => {
            const [data, setInternalData] = useState(INITIAL_DATA);
            const [isLoading, setIsLoading] = useState(true);
            const [history, setHistory] = useState([]);
            const [historyPointer, setHistoryPointer] = useState(-1);

            useEffect(() => {
                dbService.load().then((loaded) => { 
                    const fixedData = { ...INITIAL_DATA, ...loaded };
                    if (!fixedData.teachers) fixedData.teachers = [];
                    if (!fixedData.schedule) fixedData.schedule = [];
                    if (!fixedData.substitutions) fixedData.substitutions = [];
                    if (!fixedData.rooms) fixedData.rooms = INITIAL_DATA.rooms;
                    if (!fixedData.classes) fixedData.classes = [];
                    if (!fixedData.subjects) fixedData.subjects = [];
                    if (!fixedData.bellSchedule) fixedData.bellSchedule = DEFAULT_BELLS;
                    if (!fixedData.settings) fixedData.settings = { telegramToken: '' };

                    fixedData.teachers = fixedData.teachers.map(t => ({ shifts: [Shift.First, Shift.Second], telegramChatId: '', ...t }));
                    
                    setInternalData(fixedData); 
                    setHistory([fixedData]);
                    setHistoryPointer(0);
                    setIsLoading(false); 
                }).catch(e => { console.error(e); setIsLoading(false); });
            }, []);

            const saveData = async (newData, addToHistory = true) => { 
                setInternalData(newData); 
                await dbService.save(newData); 
                
                if (addToHistory) {
                    const newHistory = history.slice(0, historyPointer + 1);
                    newHistory.push(newData);
                    if(newHistory.length > 20) newHistory.shift();
                    setHistory(newHistory);
                    setHistoryPointer(newHistory.length - 1);
                }
            };

            const undo = async () => {
                if (historyPointer > 0) {
                    const prevData = history[historyPointer - 1];
                    setHistoryPointer(historyPointer - 1);
                    setInternalData(prevData);
                    await dbService.save(prevData);
                }
            };

            const redo = async () => {
                if (historyPointer < history.length - 1) {
                    const nextData = history[historyPointer + 1];
                    setHistoryPointer(historyPointer + 1);
                    setInternalData(nextData);
                    await dbService.save(nextData);
                }
            };

            const resetData = async () => { await saveData(INITIAL_DATA); };

            return (
                <DataContext.Provider value={{ 
                    data, setData: setInternalData, isLoading, saveData, resetData,
                    undo, redo, canUndo: historyPointer > 0, canRedo: historyPointer < history.length - 1 
                }}>
                    {children}
                </DataContext.Provider>
            );
        };
        const useData = () => useContext(DataContext);
        
        const StaggerContainer = ({ children, className = "" }) => {
            const childrenArray = React.Children.toArray(children);
            return (
                <div className={className}>
                    {childrenArray.map((child, i) => (
                        <div key={i} style={{ animation: `fadeIn 0.3s ease-out forwards ${i * 0.05}s`, opacity: 0 }}>
                            {child}
                        </div>
                    ))}
                </div>
            );
        };

        const SearchableSelect = ({ options, value, onChange, placeholder, groupBy }) => {
            const [isOpen, setIsOpen] = useState(false);
            const [search, setSearch] = useState("");
            const ref = useRef(null);

            useEffect(() => {
                const handleClickOutside = (event) => { if (ref.current && !ref.current.contains(event.target)) setIsOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const selectedLabel = options.flatMap(g => groupBy ? g.options : [g]).find(o => o.value === value)?.label || placeholder;
            const filteredOptions = groupBy 
                ? options.map(g => ({ ...g, options: g.options.filter(o => o.label.toLowerCase().includes(search.toLowerCase())) })).filter(g => g.options.length > 0)
                : options.filter(o => o.label.toLowerCase().includes(search.toLowerCase()));

            return (
                <div className="relative w-full" ref={ref}>
                    <div onClick={() => setIsOpen(!isOpen)} className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white cursor-pointer flex justify-between items-center">
                        <span className={!value ? "text-slate-400" : ""}>{selectedLabel}</span>
                        <Icon name="Filter" size={14} className="text-slate-400" />
                    </div>
                    {isOpen && (
                        <div className="absolute z-50 w-full mt-1 bg-white dark:bg-slate-800 border border-slate-100 dark:border-slate-600 rounded-xl shadow-xl max-h-60 overflow-auto">
                            <div className="p-2 sticky top-0 bg-white dark:bg-slate-800">
                                <input autoFocus value={search} onChange={e => setSearch(e.target.value)} placeholder="Поиск..." className="w-full bg-slate-100 dark:bg-slate-700 rounded-lg p-2 text-sm outline-none dark:text-white" />
                            </div>
                            {groupBy ? filteredOptions.map((g, i) => (
                                <div key={i}>
                                    <div className="px-3 py-1 text-xs font-bold text-slate-400 bg-slate-50 dark:bg-slate-700/50">{g.label}</div>
                                    {g.options.map(opt => (
                                        <div key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); setSearch(""); }} className={`px-3 py-2 text-sm cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/30 dark:text-slate-200 ${value === opt.value ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600' : ''}`}>
                                            {opt.label}
                                        </div>
                                    ))}
                                </div>
                            )) : filteredOptions.map(opt => (
                                <div key={opt.value} onClick={() => { onChange(opt.value); setIsOpen(false); setSearch(""); }} className={`px-3 py-2 text-sm cursor-pointer hover:bg-indigo-50 dark:hover:bg-indigo-900/30 dark:text-slate-200 ${value === opt.value ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600' : ''}`}>
                                    {opt.label}
                                </div>
                            ))}
                            {filteredOptions.length === 0 && <div className="p-3 text-center text-sm text-slate-400">Ничего не найдено</div>}
                        </div>
                    )}
                </div>
            );
        };

        const Modal = ({ isOpen, onClose, title, children, maxWidth = 'max-w-lg' }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/40 backdrop-blur-sm p-4 animate-fade-in no-print">
                    <div className={`bg-white dark:bg-dark-800 rounded-2xl shadow-2xl w-full ${maxWidth} flex flex-col max-h-[90vh] transition-colors duration-300`}>
                        <div className="flex items-center justify-between px-6 py-5 border-b border-slate-100 dark:border-slate-700">
                            <h2 className="text-xl font-bold text-slate-800 dark:text-white tracking-tight">{title}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600 dark:hover:text-slate-200 transition-colors p-1 rounded-full hover:bg-slate-100 dark:hover:bg-slate-700">
                                <Icon name="X" size={24} />
                            </button>
                        </div>
                        <div className="p-6 overflow-y-auto custom-scrollbar">{children}</div>
                    </div>
                </div>
            );
        };
        
        const ContextMenu = ({ x, y, onClose, actions }) => {
             useEffect(() => {
                 const handleClick = () => onClose();
                 window.addEventListener('click', handleClick);
                 return () => window.removeEventListener('click', handleClick);
             }, [onClose]);

             if(x === null || y === null) return null;
             
             const style = { top: y, left: x };
             if (window.innerWidth - x < 200) style.left = x - 200;

             return (
                 <div className="fixed z-[100] bg-white dark:bg-slate-800 shadow-xl rounded-xl border border-slate-100 dark:border-slate-700 py-2 w-56 context-menu no-print" style={style}>
                     {actions.map((action, i) => (
                         <button key={i} onClick={(e) => { e.stopPropagation(); action.onClick(); onClose(); }} className={`w-full text-left px-4 py-2.5 text-sm font-bold flex items-center gap-3 hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors ${action.color || 'text-slate-700 dark:text-slate-200'}`}>
                             {action.icon && <Icon name={action.icon} size={16}/>}
                             {action.label}
                         </button>
                     ))}
                 </div>
             );
        };

        const BarChart = ({ items, max, color = "indigo" }) => (
            <div className="space-y-3">
                {items.map((item, idx) => (
                    <div key={idx} className="flex items-center gap-3 text-sm">
                        <div className="w-32 truncate font-medium text-slate-700 dark:text-slate-300" title={item.label}>{item.label}</div>
                        <div className="flex-1 h-4 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden">
                            <div className={`h-full rounded-full bg-${color}-500 transition-all duration-500`} style={{ width: `${(item.value / max) * 100}%` }}></div>
                        </div>
                        <div className="w-12 text-right font-bold text-slate-800 dark:text-slate-200">{item.value}</div>
                    </div>
                ))}
            </div>
        );

        const StatusWidget = () => {
            const { data } = useData();
            const [status, setStatus] = useState("Загрузка...");
            const [details, setDetails] = useState("");
            const [progress, setProgress] = useState(0);
            const [color, setColor] = useState("bg-slate-500");
            const [currentDayName, setCurrentDayName] = useState("");

            useEffect(() => {
                const updateStatus = () => {
                    const now = new Date();
                    const dayIndex = now.getDay();
                    const dayMap = [null, DayOfWeek.Monday, DayOfWeek.Tuesday, DayOfWeek.Wednesday, DayOfWeek.Thursday, DayOfWeek.Friday, null];
                    const todayName = dayMap[dayIndex];
                    setCurrentDayName(todayName || "Выходной");

                    if (!todayName) {
                        setStatus("Сегодня выходной");
                        setDetails("Уроков нет");
                        setColor("bg-slate-400");
                        setProgress(0);
                        return;
                    }

                    const minutesNow = now.getHours() * 60 + now.getMinutes();
                    
                    let dailyBells = data.bellSchedule.filter(b => b.day === todayName);
                    if (dailyBells.length === 0) dailyBells = data.bellSchedule.filter(b => b.day === 'default');
                    
                    let activeLesson = null;
                    
                    const timeToMin = (t) => {
                        const [h, m] = t.split(':').map(Number);
                        return h * 60 + m;
                    };

                    for (const bell of dailyBells) {
                        const start = timeToMin(bell.start);
                        const end = timeToMin(bell.end);
                        if (minutesNow >= start && minutesNow < end) {
                            activeLesson = { ...bell, duration: end - start, passed: minutesNow - start };
                            break;
                        }
                    }

                    if (activeLesson) {
                        setStatus(`${activeLesson.period} урок`);
                        setDetails(`${activeLesson.shift === Shift.First ? '1 смена' : '2 смена'} • ост. ${activeLesson.duration - activeLesson.passed} мин`);
                        setProgress((activeLesson.passed / activeLesson.duration) * 100);
                        setColor("bg-indigo-600");
                    } else {
                        let minDiff = Infinity;
                        let next = null;
                        for(const bell of dailyBells) {
                            const start = timeToMin(bell.start);
                            if(start > minutesNow && (start - minutesNow) < minDiff) {
                                minDiff = start - minutesNow;
                                next = bell;
                            }
                        }

                        if (next && minDiff < 30) {
                            setStatus("Перемена");
                            setDetails(`через ${minDiff} мин ${next.period} урок (${next.shift === Shift.First ? '1см' : '2см'})`);
                            setColor("bg-amber-500");
                            setProgress(100 - (minDiff / 20 * 100));
                        } else {
                            setStatus("Уроков нет");
                            setDetails("Свободное время");
                            setColor("bg-slate-400");
                            setProgress(0);
                        }
                    }
                };

                updateStatus();
                const interval = setInterval(updateStatus, 60000); 
                return () => clearInterval(interval);
            }, [data.bellSchedule]);

            return (
                <div className="mx-4 mt-auto mb-4 p-4 bg-white dark:bg-slate-800 rounded-2xl shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col gap-3 relative overflow-hidden group">
                     <div className={`absolute top-0 left-0 w-1 h-full ${color}`}></div>
                     <div className="flex justify-between items-start z-10">
                        <div>
                            <div className="text-[10px] uppercase font-bold text-slate-400 tracking-wider mb-0.5">{currentDayName}</div>
                            <div className="text-lg font-black text-slate-800 dark:text-white leading-none mb-1">{status}</div>
                            <div className="text-xs font-medium text-slate-500 dark:text-slate-400">{details}</div>
                        </div>
                        <div className={`w-8 h-8 rounded-full ${color} bg-opacity-10 dark:bg-opacity-20 flex items-center justify-center text-${color.replace('bg-', '')}`}>
                             <Icon name="Clock" size={16} className={color.replace('bg-', 'text-')} />
                        </div>
                     </div>
                     {progress > 0 && (
                         <div className="w-full h-1.5 bg-slate-100 dark:bg-slate-700 rounded-full overflow-hidden mt-1">
                             <div className={`h-full ${color} transition-all duration-1000`} style={{ width: `${progress}%` }}></div>
                         </div>
                     )}
                </div>
            );
        };
        
        const DashboardPage = () => {
            const { data } = useData();
            const [notes, setNotes] = useState(localStorage.getItem('gym_notes') || '');
            const [currentDate] = useState(new Date());
            const [saveStatus, setSaveStatus] = useState(''); 
            const [searchQuery, setSearchQuery] = useState("");
            const [searchResult, setSearchResult] = useState(null);
            const [showAbsentList, setShowAbsentList] = useState(false);

            useEffect(() => { 
                localStorage.setItem('gym_notes', notes); 
                if(notes) {
                    setSaveStatus('Сохранено');
                    const t = setTimeout(() => setSaveStatus(''), 2000);
                    return () => clearTimeout(t);
                }
            }, [notes]);

            const getLocalDateString = (date) => {
                const d = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
                return d.toISOString().split('T')[0];
            };

            const upcomingBirthdays = useMemo(() => {
                const today = new Date();
                today.setHours(0,0,0,0);
                return data.teachers
                  .filter(t => t.birthDate)
                  .map(t => {
                    const bDate = new Date(t.birthDate);
                    let next = new Date(today.getFullYear(), bDate.getMonth(), bDate.getDate());
                    if (next < today) next.setFullYear(today.getFullYear() + 1);
                    const diff = Math.ceil((next - today) / (1000 * 60 * 60 * 24));
                    return { ...t, diff, age: today.getFullYear() - bDate.getFullYear() };
                  })
                  .filter(t => t.diff <= 30)
                  .sort((a, b) => a.diff - b.diff);
            }, [data.teachers]);
            
            const occupancyStats = useMemo(() => {
                const todayStr = getLocalDateString(new Date());
                const totalTeachers = data.teachers.length;
                const absentTeachersList = data.teachers.filter(t => t.unavailableDates.includes(todayStr));
                const absentCount = absentTeachersList.length;
                const presentCount = totalTeachers - absentCount;
                const presentPercent = totalTeachers > 0 ? Math.round((presentCount / totalTeachers) * 100) : 0;
                
                return { presentPercent, absentCount, totalTeachers, absentTeachersList };
            }, [data.teachers]);

            const problemZones = useMemo(() => {
                const nextDay = new Date(currentDate);
                nextDay.setDate(currentDate.getDate() + 1);
                while (nextDay.getDay() === 0 || nextDay.getDay() === 6) nextDay.setDate(nextDay.getDate() + 1);
                
                const dayMap = [null, 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', null];
                const nextDayName = dayMap[nextDay.getDay()];
                if (!nextDayName) return [];

                const problems = [];
                data.classes.forEach(cls => {
                    const lessons = data.schedule.filter(s => s.classId === cls.id && s.day === nextDayName);
                    
                    if (lessons.length === 0) {
                        problems.push({ class: cls.name, issue: `Нет уроков на ${nextDayName}` });
                    } else if (lessons.length < 4) {
                        problems.push({ class: cls.name, issue: `Мало уроков (${lessons.length})` });
                    }
                    
                    lessons.forEach(l => {
                        const teacherConflict = data.schedule.some(s => s.id !== l.id && s.day === nextDayName && s.period === l.period && s.shift === l.shift && s.teacherId === l.teacherId);
                        if(teacherConflict) problems.push({ class: cls.name, issue: `Конфликт учителя (${l.period} ур)` });
                        
                        if (l.roomId) {
                            const room = data.rooms.find(r => r.id === l.roomId);
                            if (room && room.capacity < cls.studentsCount) {
                                problems.push({ class: cls.name, issue: `Тесно: ${room.name} (${l.period} ур)` });
                            }
                        }
                    });
                });
                return problems.filter((v,i,a)=>a.findIndex(t=>(t.class === v.class && t.issue === v.issue))===i).slice(0, 10);
            }, [data.schedule, data.classes, data.teachers, data.rooms, currentDate]);

            const handleSearch = () => {
                if (!searchQuery) { setSearchResult(null); return; }
                const now = new Date();
                const dayMap = [null, 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', null];
                const todayName = dayMap[now.getDay()];
                
                if (!todayName) { 
                    setSearchResult({ status: 'Выходной', detail: 'Сегодня уроков нет', color: 'text-slate-500' }); 
                    return; 
                }
                
                const timeToMin = (t) => { const [h, m] = t.split(':').map(Number); return h * 60 + m; };
                const minutesNow = now.getHours() * 60 + now.getMinutes();

                const bell = data.bellSchedule.find(b => {
                     const start = timeToMin(b.start);
                     const end = timeToMin(b.end);
                     return minutesNow >= start && minutesNow <= end && (b.day === todayName || b.day === 'default');
                });

                const q = searchQuery.toLowerCase();
                const teacher = data.teachers.find(t => t.name.toLowerCase().includes(q));
                const cls = data.classes.find(c => c.name.toLowerCase().includes(q));

                if (!teacher && !cls) {
                    setSearchResult({ status: 'Не найдено', detail: 'Проверьте запрос', color: 'text-red-500' });
                    return;
                }

                const todayStr = getLocalDateString(now);

                if (teacher) {
                    if (teacher.unavailableDates.includes(todayStr)) {
                        setSearchResult({ status: 'Отсутствует', detail: 'Болезнь/Отгул', color: 'text-red-500', icon: 'UserX', items: [] });
                        return;
                    }
                    if (!bell) {
                        setSearchResult({ status: 'Перемена / Нет урока', detail: 'Свободное время', color: 'text-amber-500', icon: 'Clock', items: [] });
                    } else {
                        const lessons = data.schedule.filter(s => s.teacherId === teacher.id && s.day === todayName && s.period === bell.period);
                        if (lessons.length > 0) {
                            const items = lessons.map(lesson => {
                                const room = data.rooms.find(r => r.id === lesson.roomId)?.name || lesson.roomId || "без каб.";
                                const subject = data.subjects.find(s => s.id === lesson.subjectId)?.name;
                                const className = data.classes.find(c => c.id === lesson.classId)?.name;
                                return { room, subject, entityName: className, direction: lesson.direction };
                            });
                            setSearchResult({ status: `Урок ${bell.period}`, detail: '', color: 'text-emerald-600', icon: 'MapPin', items });
                        } else {
                            setSearchResult({ status: 'Окно', detail: `Сейчас (Урок ${bell.period}) свободен`, color: 'text-blue-500', icon: 'User', items: [] });
                        }
                    }
                } else if (cls) {
                    if (!bell) {
                        setSearchResult({ status: 'Перемена', detail: 'Класс свободен', color: 'text-amber-500', icon: 'Clock', items: [] });
                    } else {
                        const lessons = data.schedule.filter(s => s.classId === cls.id && s.day === todayName && s.period === bell.period);
                        if (lessons.length > 0) {
                            const items = lessons.map(lesson => {
                                const room = data.rooms.find(r => r.id === lesson.roomId)?.name || lesson.roomId || "без каб.";
                                const subject = data.subjects.find(s => s.id === lesson.subjectId)?.name;
                                const teacherName = data.teachers.find(t => t.id === lesson.teacherId)?.name;
                                return { room, subject, entityName: teacherName, direction: lesson.direction };
                            });
                            setSearchResult({ status: `Урок ${bell.period}`, detail: '', color: 'text-emerald-600', icon: 'MapPin', items });
                        } else {
                            setSearchResult({ status: 'Нет урока', detail: 'Класс свободен', color: 'text-blue-500', icon: 'BookOpen', items: [] });
                        }
                    }
                }
            };

            return (
                <div className="max-w-7xl mx-auto space-y-6 pb-20">
                    <header className="mb-6">
                         <h1 className="text-2xl font-black text-slate-800 dark:text-white">Рабочий стол завуча</h1>
                         <p className="text-slate-500 dark:text-slate-400 text-sm font-medium">{currentDate.toLocaleDateString('ru-RU', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    </header>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full relative overflow-hidden">
                            <div className="flex items-center gap-3 mb-4"><div className="bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 p-2 rounded-lg"><Icon name="Search" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Кто где?</h3></div>
                            <div className="flex gap-2 mb-4">
                                <input placeholder="Учитель или класс..." value={searchQuery} onChange={e => setSearchQuery(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleSearch()} className="w-full bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm outline-none dark:text-white" />
                                <button onClick={handleSearch} className="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-xl transition-colors"><Icon name="Search" size={20}/></button>
                            </div>
                            {searchResult && (
                                <div className="mt-auto p-3 bg-slate-50 dark:bg-slate-700/30 rounded-xl border border-slate-100 dark:border-slate-700 animate-fade-in">
                                    <div className={`text-xs font-bold uppercase mb-2 flex items-center gap-2 ${searchResult.color}`}><Icon name={searchResult.icon || 'Info'} size={14}/> {searchResult.status}</div>
                                    {searchResult.items && searchResult.items.length > 0 ? (
                                        <div className="space-y-2">
                                            {searchResult.items.map((item, idx) => (
                                                <div key={idx} className="bg-white dark:bg-dark-800 p-2 rounded-lg border border-slate-100 dark:border-slate-600 text-xs shadow-sm">
                                                    {item.direction && <div className="text-[10px] font-bold text-indigo-500 mb-0.5">{item.direction}</div>}
                                                    <div className="font-bold text-slate-700 dark:text-slate-200">{item.subject}</div>
                                                    <div className="flex justify-between items-center mt-1 text-slate-500 dark:text-slate-400">
                                                        <span>{item.entityName}</span>
                                                        <span className="bg-slate-100 dark:bg-slate-700 px-1.5 rounded font-mono">{item.room}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="font-bold text-slate-800 dark:text-white text-sm leading-snug">{searchResult.detail}</div>
                                    )}
                                </div>
                            )}
                        </div>

                         <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3"><div className="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 p-2 rounded-lg"><Icon name="PieChart" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Наполняемость</h3></div>
                                <button onClick={() => setShowAbsentList(!showAbsentList)} className="p-2 text-slate-400 hover:text-indigo-600 hover:bg-slate-50 dark:hover:bg-slate-700 rounded-lg transition-colors" title={showAbsentList ? "Показать график" : "Список отсутствующих"}>
                                    <Icon name={showAbsentList ? "PieChart" : "List"} size={20}/>
                                </button>
                            </div>
                            
                            {showAbsentList ? (
                                <div className="flex-1 overflow-y-auto custom-scrollbar animate-fade-in">
                                    {occupancyStats.absentTeachersList.length > 0 ? (
                                        <div className="space-y-2">
                                            {occupancyStats.absentTeachersList.map(t => (
                                                <div key={t.id} className="flex justify-between items-center text-sm border-b border-slate-50 dark:border-slate-700 pb-1 mb-1 last:border-0">
                                                    <span className="font-medium text-slate-700 dark:text-slate-300 truncate pr-2">{t.name}</span>
                                                    <span className="text-xs text-red-500 font-bold whitespace-nowrap">{t.absenceReasons?.[getLocalDateString(currentDate)] || "Отсутствует"}</span>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <div className="h-full flex flex-col items-center justify-center text-center text-slate-400">
                                            <Icon name="CheckCircle" size={32} className="text-emerald-400 mb-2"/>
                                            <p className="text-sm">Все учителя на месте</p>
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="flex items-center justify-between flex-1 animate-fade-in">
                                    <div className="relative w-24 h-24">
                                         <svg viewBox="0 0 36 36" className="w-full h-full transform -rotate-90">
                                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#f1f5f9" strokeWidth="4" className="dark:stroke-slate-700" />
                                            <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#10b981" strokeWidth="4" strokeDasharray={`${occupancyStats.presentPercent}, 100`} />
                                         </svg>
                                         <div className="absolute inset-0 flex flex-col items-center justify-center">
                                             <span className="text-xs text-slate-400 font-bold">Присут.</span>
                                             <span className="font-black text-slate-700 dark:text-white">{occupancyStats.presentPercent}%</span>
                                         </div>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-3xl font-black text-red-500">{occupancyStats.absentCount}</div>
                                        <div className="text-xs text-slate-400 font-bold uppercase leading-tight">Учителей<br/>отсутствует</div>
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full">
                            <div className="flex items-center gap-3 mb-4"><div className="bg-rose-100 dark:bg-rose-900/30 text-rose-600 dark:text-rose-400 p-2 rounded-lg"><Icon name="Gift" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Дни рождения</h3></div>
                            <div className="flex-1 overflow-y-auto max-h-40 custom-scrollbar space-y-3">{upcomingBirthdays.length ? upcomingBirthdays.map(t => <div key={t.id} className="flex justify-between text-sm text-slate-700 dark:text-slate-300"><span>{t.name}</span><span className="font-bold text-slate-400">{t.diff === 0 ? 'Сегодня!' : `${t.diff} дн.`}</span></div>) : <div className="text-slate-400 text-sm text-center">Нет ближайших</div>}</div>
                        </div>
                        
                        <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col h-full">
                            <div className="flex items-center gap-3 mb-4"><div className="bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 p-2 rounded-lg"><Icon name="AlertTriangle" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Конфликты</h3></div>
                            <div className="flex-1 overflow-y-auto max-h-40 custom-scrollbar space-y-2">{problemZones.length ? problemZones.map((p,i) => <div key={i} className="flex justify-between text-sm text-slate-700 dark:text-slate-300"><span>{p.class}</span><span className="text-amber-600 text-xs font-bold">{p.issue}</span></div>) : <div className="text-slate-400 text-sm text-center">Расписание в порядке</div>}</div>
                        </div>

                        <div className="md:col-span-2 lg:col-span-4 bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col relative group">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3"><div className="bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 p-2 rounded-lg"><Icon name="CheckSquare" size={20}/></div><h3 className="font-bold text-lg dark:text-white">Быстрые заметки</h3></div>
                                <div className="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => { navigator.clipboard.writeText(notes); alert('Скопировано'); }} className="text-xs bg-slate-100 dark:bg-slate-700 px-2 py-1 rounded font-bold text-slate-500 hover:text-indigo-600">Копировать</button>
                                    <button onClick={() => { if(confirm('Очистить заметки?')) setNotes(''); }} className="text-xs bg-red-50 dark:bg-red-900/30 px-2 py-1 rounded font-bold text-red-500 hover:text-red-700">Очистить</button>
                                </div>
                            </div>
                            <div className="relative flex-1">
                                <textarea 
                                    className="w-full h-48 p-6 rounded-xl bg-yellow-50 dark:bg-slate-700 border border-yellow-200 dark:border-slate-600 outline-none font-medium text-slate-700 dark:text-slate-200 resize-none focus:ring-4 ring-yellow-100 dark:ring-slate-600/50 transition-shadow leading-relaxed shadow-inner" 
                                    placeholder="Список задач на сегодня..." 
                                    value={notes} 
                                    onChange={e => setNotes(e.target.value)}
                                    style={{ backgroundImage: 'linear-gradient(transparent, transparent 27px, #e5e7eb 28px)', backgroundSize: '100% 28px', lineHeight: '28px' }}
                                />
                                {saveStatus && <div className="absolute bottom-4 right-4 text-[10px] font-bold uppercase tracking-widest text-slate-400 animate-fade-in flex items-center gap-1"><Icon name="Save" size={12}/> {saveStatus}</div>}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const SchedulePage = ({ readOnly = false }) => {
            const { data, saveData, canUndo, canRedo, undo, redo } = useData();
            const navigate = useNavigate();
            const [selectedShift, setSelectedShift] = useState(Shift.First);
            const [selectedDay, setSelectedDay] = useState(DayOfWeek.Monday);
            const [isEditorOpen, setIsEditorOpen] = useState(false);
            const [tempItem, setTempItem] = useState({});
            const [viewMode, setViewMode] = useState('class');
            const [filterId, setFilterId] = useState('');
            const [filterRoom, setFilterRoom] = useState('');
            const [filterDirection, setFilterDirection] = useState('');
            const [isPrintModalOpen, setIsPrintModalOpen] = useState(false);
            const [contextMenu, setContextMenu] = useState({ visible: false, x: 0, y: 0, item: null, cell: null });
            const [clipboard, setClipboard] = useState(null);
            
            const [validationWarnings, setValidationWarnings] = useState([]);
            
            const [draggedItem, setDraggedItem] = useState(null);
            const [dragOverCell, setDragOverCell] = useState(null);

            const currentPeriods = SHIFT_PERIODS[selectedShift];
            
            const getRows = () => {
                if (viewMode === 'week') return SHIFT_PERIODS[selectedShift].map(p => ({ id: p, name: `${p} урок` }));
                if (viewMode === 'class') return filterId ? data.classes.filter(c => c.id === filterId && c.shift === selectedShift) : data.classes.filter(c => c.shift === selectedShift);
                if (viewMode === 'teacher') return filterId ? data.teachers.filter(t => t.id === filterId) : data.teachers;
                if (viewMode === 'subject') return filterId ? data.subjects.filter(s => s.id === filterId) : data.subjects;
                return [];
            };

            const getScheduleItems = (rowId, colKey) => {
                let items = [];
                if (viewMode === 'week') {
                     const period = rowId;
                     const day = colKey;
                     items = data.schedule.filter(s => s.shift === selectedShift && s.period === period && s.day === day);
                     if (filterId) items = items.filter(s => s.classId === filterId);
                } else {
                    const period = colKey;
                    if (viewMode === 'class') items = data.schedule.filter(s => s.classId === rowId && s.period === period && s.day === selectedDay && s.shift === selectedShift);
                    if (viewMode === 'teacher') items = data.schedule.filter(s => s.teacherId === rowId && s.period === period && s.day === selectedDay && s.shift === selectedShift);
                    if (viewMode === 'subject') items = data.schedule.filter(s => s.subjectId === rowId && s.period === period && s.day === selectedDay && s.shift === selectedShift);
                }

                if (filterRoom) {
                    items = items.filter(s => {
                        if (!s.roomId) return false;
                        const room = data.rooms.find(r => r.id === s.roomId);
                        const roomName = room ? room.name : s.roomId;
                        return roomName.toLowerCase().includes(filterRoom.toLowerCase());
                    });
                }
                if (filterDirection) items = items.filter(s => s.direction?.toLowerCase().includes(filterDirection.toLowerCase()));
                
                return items;
            };

            const checkConflicts = (item) => {
                const conflicts = [];
                const others = data.schedule.filter(s => s.id !== item.id && s.day === item.day && s.period === item.period && s.shift === item.shift);
                
                const teacherBusy = others.find(s => s.teacherId === item.teacherId);
                if (teacherBusy) conflicts.push('teacher');

                const classBusy = others.find(s => {
                    if (s.classId !== item.classId) return false;
                    if (s.direction && item.direction && s.direction !== item.direction) return false;
                    return true; 
                });
                if (classBusy) conflicts.push('class');

                if (item.roomId) {
                    const roomBusy = others.find(s => s.roomId === item.roomId);
                    if (roomBusy) conflicts.push('room');
                }

                return conflicts;
            };

            const validateRoom = (classId, subjectId, roomId) => {
                const warnings = [];
                const cls = data.classes.find(c => c.id === classId);
                const subj = data.subjects.find(s => s.id === subjectId);
                const room = data.rooms.find(r => r.id === roomId);

                if (!room) return warnings;

                if (cls && room.capacity < cls.studentsCount) {
                    warnings.push(`⚠️ Мало мест! В классе ${cls.studentsCount} уч., а в кабинете только ${room.capacity}.`);
                }

                if (subj && subj.requiredRoomType && subj.requiredRoomType !== 'Обычный' && room.type !== subj.requiredRoomType) {
                    warnings.push(`🚫 Не тот тип! Предмет требует "${subj.requiredRoomType}", а кабинет "${room.type}".`);
                }

                return warnings;
            };

            const updateValidation = (item) => {
                const warns = validateRoom(item.classId, item.subjectId, item.roomId);
                setValidationWarnings(warns);
            }

            const handleEditItem = (item) => { 
                if(readOnly) return; 
                setTempItem(item); 
                updateValidation(item);
                setIsEditorOpen(true); 
            };
            const handleAddItem = (rowId, period, day = selectedDay) => {
                if(readOnly) return;
                const base = { period, day, shift: selectedShift, id: Math.random().toString(36).substr(2, 9) };
                if (viewMode === 'class') base.classId = rowId;
                if (viewMode === 'teacher') base.teacherId = rowId;
                if (viewMode === 'subject') base.subjectId = rowId;
                if (viewMode === 'week') { 
                    base.period = rowId; 
                    if(filterId && data.classes.find(c => c.id === filterId)) base.classId = filterId; 
                }
                setTempItem(base); 
                setValidationWarnings([]);
                setIsEditorOpen(true); 
            };
            const handleSaveItem = async () => {
                if (!tempItem.subjectId || !tempItem.teacherId || !tempItem.classId) return;
                let newSchedule = [...data.schedule];
                const idx = newSchedule.findIndex(s => s.id === tempItem.id);
                if (idx >= 0) newSchedule[idx] = tempItem; else newSchedule.push(tempItem);
                await saveData({ ...data, schedule: newSchedule });
                setIsEditorOpen(false);
            };
            const handleDeleteItem = async (id) => {
                const newSchedule = data.schedule.filter(s => s.id !== (id || tempItem.id));
                await saveData({ ...data, schedule: newSchedule });
                setIsEditorOpen(false);
            };

            const handleContextMenu = (e, item, cellInfo) => {
                if(readOnly) return;
                e.preventDefault();
                e.stopPropagation(); 
                setContextMenu({ visible: true, x: e.clientX, y: e.clientY, item, cell: cellInfo });
            };

            const handleDragStart = (e, item) => {
                if(readOnly) return;
                setDraggedItem(item);
                e.dataTransfer.effectAllowed = "move";
                const el = e.target;
                setTimeout(() => el.classList.add('dragging'), 0);
            };

            const handleDragEnd = (e) => {
                e.target.classList.remove('dragging');
                setDraggedItem(null);
                setDragOverCell(null);
            };

            const handleDragOver = (e, cellInfo) => {
                e.preventDefault();
                if(readOnly) return;
                setDragOverCell(`${cellInfo.rowId}-${cellInfo.colKey}`);
            };

            const handleDrop = async (e, cellInfo) => {
                e.preventDefault();
                if (!draggedItem || readOnly) return;

                const newItem = { ...draggedItem };
                
                if (viewMode === 'week') {
                    newItem.period = cellInfo.rowId;
                    newItem.day = cellInfo.colKey;
                } else {
                    newItem.period = cellInfo.colKey;
                    newItem.day = selectedDay;
                    if (viewMode === 'class') newItem.classId = cellInfo.rowId;
                    if (viewMode === 'teacher') newItem.teacherId = cellInfo.rowId;
                    if (viewMode === 'subject') newItem.subjectId = cellInfo.rowId;
                }

                let newSchedule = data.schedule.map(s => s.id === newItem.id ? newItem : s);
                await saveData({ ...data, schedule: newSchedule });
                setDraggedItem(null);
                setDragOverCell(null);
            };

            const contextActions = [];
            if (contextMenu.item) {
                contextActions.push(
                    { label: 'Копировать', icon: 'Copy', onClick: () => setClipboard(contextMenu.item) },
                    { label: 'Удалить', icon: 'Trash2', color: 'text-red-600', onClick: () => handleDeleteItem(contextMenu.item.id) }
                );
            } else if (contextMenu.cell) {
                if (clipboard) {
                    contextActions.push({ label: 'Вставить', icon: 'Clipboard', onClick: async () => {
                         const newItem = { ...clipboard, id: Math.random().toString(36).substr(2, 9), day: selectedDay, shift: selectedShift, period: contextMenu.cell.colKey }; 
                         if(viewMode === 'week') { newItem.day = contextMenu.cell.colKey; newItem.period = contextMenu.cell.rowId; }
                         if(viewMode === 'class') newItem.classId = contextMenu.cell.rowId;
                         let newSchedule = [...data.schedule, newItem];
                         await saveData({ ...data, schedule: newSchedule });
                         setClipboard(null);
                    }});
                }
                contextActions.push({ label: 'Добавить урок', icon: 'Plus', onClick: () => handleAddItem(contextMenu.cell.rowId, contextMenu.cell.colKey, viewMode === 'week' ? contextMenu.cell.colKey : selectedDay) });
            }

            const recommendedTeachers = tempItem.subjectId ? data.teachers.filter(t => t.subjectIds.includes(tempItem.subjectId)) : [];
            const otherTeachers = tempItem.subjectId ? data.teachers.filter(t => !t.subjectIds.includes(tempItem.subjectId)) : data.teachers;

            const printTitle = viewMode === 'teacher' && filterId ? data.teachers.find(t=>t.id===filterId)?.name 
                             : viewMode === 'class' && filterId ? data.classes.find(c=>c.id===filterId)?.name 
                             : viewMode === 'subject' && filterId ? data.subjects.find(s=>s.id===filterId)?.name
                             : 'Расписание';
            
            const rows = getRows();
            const cols = viewMode === 'week' ? DAYS : currentPeriods;

            return (
                <div className="h-full flex flex-col">
                    {contextMenu.visible && <ContextMenu x={contextMenu.x} y={contextMenu.y} onClose={()=>setContextMenu({...contextMenu, visible:false})} actions={contextActions} />}
                    <div className="bg-white dark:bg-dark-800 p-4 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6 flex flex-col xl:flex-row gap-4 items-start xl:items-center justify-between no-print">
                         <div className="flex gap-4 items-center flex-wrap">
                            <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                <button onClick={() => setSelectedShift(Shift.First)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${selectedShift === Shift.First ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>1 смена</button>
                                <button onClick={() => setSelectedShift(Shift.Second)} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${selectedShift === Shift.Second ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>2 смена</button>
                            </div>
                            {viewMode !== 'week' && (
                                <div className="flex overflow-x-auto pb-1 gap-1 max-w-[40vw] hide-scrollbar">
                                    {DAYS.map(day => <button key={day} onClick={() => setSelectedDay(day)} className={`whitespace-nowrap px-4 py-2 rounded-xl text-sm font-bold transition-all ${selectedDay === day ? 'bg-indigo-600 text-white shadow-md shadow-indigo-200' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700'}`}>{day}</button>)}
                                </div>
                            )}
                             {!readOnly && (
                                <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                    <button onClick={undo} disabled={!canUndo} className="p-2 text-slate-500 disabled:opacity-30 hover:bg-white dark:hover:bg-slate-600 rounded-lg transition"><Icon name="RotateCcw" size={18}/></button>
                                    <button onClick={redo} disabled={!canRedo} className="p-2 text-slate-500 disabled:opacity-30 hover:bg-white dark:hover:bg-slate-600 rounded-lg transition"><Icon name="RotateCw" size={18}/></button>
                                </div>
                            )}
                        </div>
                        <div className="flex flex-wrap items-center gap-3 w-full xl:w-auto">
                             <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                 <button onClick={()=>{setViewMode('class'); setFilterId('')}} className={`p-2 rounded-md ${viewMode==='class'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white':'text-slate-400'}`} title="По классам"><Icon name="GraduationCap" size={18}/></button>
                                 <button onClick={()=>{setViewMode('teacher'); setFilterId('')}} className={`p-2 rounded-md ${viewMode==='teacher'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white':'text-slate-400'}`} title="По учителям"><Icon name="Users" size={18}/></button>
                                 <button onClick={()=>{setViewMode('subject'); setFilterId('')}} className={`p-2 rounded-md ${viewMode==='subject'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white':'text-slate-400'}`} title="По предметам"><Icon name="BookOpen" size={18}/></button>
                                 <button onClick={()=>{setViewMode('week'); setFilterId(data.classes[0]?.id || '')}} className={`p-2 rounded-md ${viewMode==='week'?'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white':'text-slate-400'}`} title="Неделя"><Icon name="Calendar" size={18}/></button>
                             </div>
                             
                             <div className="flex items-center gap-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-1.5 pl-3 flex-1">
                                <Icon name="Filter" size={16} className="text-slate-400" />
                                <select value={filterId} onChange={(e) => setFilterId(e.target.value)} className="bg-transparent text-sm font-bold text-slate-700 dark:text-slate-200 outline-none w-full xl:w-32">
                                    <option value="">Все {viewMode === 'class' ? 'классы' : viewMode === 'teacher' ? 'учителя' : viewMode === 'week' ? 'классы (неделя)' : 'предметы'}</option>
                                    {(viewMode === 'class' || viewMode === 'week') && data.classes.filter(c=>c.shift===selectedShift).map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                                    {viewMode === 'teacher' && data.teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                    {viewMode === 'subject' && data.subjects.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                </select>
                            </div>
                            <input placeholder="Каб..." value={filterRoom} onChange={e=>setFilterRoom(e.target.value)} className="w-20 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-xs font-bold" />
                            <input placeholder="Проф..." value={filterDirection} onChange={e=>setFilterDirection(e.target.value)} className="w-20 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg p-2 text-xs font-bold" />

                            {(filterId || viewMode === 'week') && (
                                <button onClick={() => setIsPrintModalOpen(true)} className="flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-bold shadow-lg shadow-indigo-200 dark:shadow-none transition-all">
                                    <Icon name="Printer" size={16}/>
                                </button>
                            )}
                        </div>
                    </div>

                    <div className="flex-1 bg-white dark:bg-dark-800 rounded-2xl shadow-xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700 overflow-hidden flex flex-col transition-colors duration-300 no-print">
                        <div className="overflow-auto flex-1 custom-scrollbar">
                            <table className="w-full border-collapse min-w-[1000px]">
                                <thead className="bg-slate-50 dark:bg-slate-700 sticky top-0 z-20">
                                    <tr>
                                        <th className="p-4 border-b border-r border-slate-100 dark:border-slate-600 text-left text-xs font-extrabold text-slate-400 uppercase w-40 sticky left-0 bg-slate-50 dark:bg-slate-700 z-30">
                                            {viewMode === 'week' ? 'Урок' : viewMode === 'class' ? 'Класс' : viewMode === 'teacher' ? 'Учитель' : 'Предмет'}
                                        </th>
                                        {cols.map(col => <th key={col} className="p-4 border-b border-slate-100 dark:border-slate-600 text-center text-xs font-extrabold text-slate-400 uppercase min-w-[160px]">{viewMode === 'week' ? col : `${col} урок`}</th>)}
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50 dark:divide-slate-700">
                                    {rows.length > 0 ? rows.map(row => (
                                        <tr key={row.id}>
                                            <td className="p-4 border-r border-slate-100 dark:border-slate-600 font-black text-lg text-slate-700 dark:text-slate-200 sticky left-0 bg-white dark:bg-dark-800 z-10 text-left">{row.name}</td>
                                            {cols.map(colKey => {
                                                const items = getScheduleItems(row.id, colKey);
                                                const cellId = `${row.id}-${colKey}`;
                                                return (
                                                    <td 
                                                        key={colKey} 
                                                        className={`p-2 border-r border-slate-50 dark:border-slate-700 h-28 align-top transition-colors ${dragOverCell === cellId ? 'drag-over' : 'hover:bg-slate-50 dark:hover:bg-slate-700/50'}`}
                                                        onContextMenu={(e) => handleContextMenu(e, null, { rowId: row.id, colKey })}
                                                        onDragOver={(e) => handleDragOver(e, { rowId: row.id, colKey })}
                                                        onDrop={(e) => handleDrop(e, { rowId: row.id, colKey })}
                                                    >
                                                        <div className="h-full flex flex-col gap-1">
                                                            {items.map(item => {
                                                                const subj = data.subjects.find(s => s.id === item.subjectId);
                                                                const teacher = data.teachers.find(t => t.id === item.teacherId);
                                                                const cls = data.classes.find(c => c.id === item.classId);
                                                                const conflicts = checkConflicts(item);
                                                                const room = data.rooms.find(r => r.id === item.roomId);
                                                                const roomName = room ? room.name : item.roomId;

                                                                return (
                                                                    <div 
                                                                        key={item.id} 
                                                                        draggable={!readOnly}
                                                                        onDragStart={(e) => handleDragStart(e, item)}
                                                                        onDragEnd={handleDragEnd}
                                                                        onClick={() => handleEditItem(item)} 
                                                                        onContextMenu={(e) => handleContextMenu(e, item, null)} 
                                                                        className={`rounded-lg p-2 text-xs shadow-sm hover:shadow-md cursor-grab active:cursor-grabbing border flex flex-col gap-0.5 flex-1 relative group transition-transform ${conflicts.length > 0 ? 'border-red-300 bg-red-50 dark:bg-red-900/20 ring-1 ring-red-200' : 'border-slate-100 dark:border-slate-600'}`} 
                                                                        style={conflicts.length === 0 && subj?.color ? { backgroundColor: `${subj.color}40` } : {}}
                                                                    >
                                                                        <div className="flex justify-between items-center gap-1">
                                                                            <span className="font-bold text-slate-800 dark:text-slate-200 line-clamp-1">{viewMode === 'subject' || viewMode === 'week' ? cls?.name : subj?.name}</span>
                                                                            {item.direction && <span className="text-[9px] px-1 rounded bg-white/80 dark:bg-black/30 font-bold text-slate-600 dark:text-slate-300">{item.direction}</span>}
                                                                        </div>
                                                                        {viewMode === 'week' && <div className="font-bold text-slate-800 dark:text-slate-200 line-clamp-1">{subj?.name}</div>}
                                                                        <div className="flex justify-between items-center mt-auto">
                                                                            <div className="text-slate-600 dark:text-slate-400 text-[10px] flex items-center gap-1 leading-tight overflow-hidden" title={teacher?.name}>
                                                                                <Icon name={viewMode === 'teacher' ? 'GraduationCap' : 'User'} size={10} className="shrink-0" /> 
                                                                                <span className="truncate">
                                                                                    {viewMode === 'teacher' ? cls?.name : teacher?.name}
                                                                                </span>
                                                                            </div>
                                                                            {roomName && <div className="text-[9px] font-mono text-slate-400 bg-white/50 dark:bg-black/20 rounded px-1 flex items-center gap-0.5 shrink-0" title={room ? `Вмест: ${room.capacity}, Тип: ${room.type}` : ''}>{roomName}</div>}
                                                                        </div>
                                                                        {conflicts.length > 0 && <div className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px] font-bold" title={`Конфликт: ${conflicts.join(', ')}`}>!</div>}
                                                                    </div>
                                                                )
                                                            })}
                                                            {!readOnly && items.length < 3 && <button onClick={() => handleAddItem(row.id, colKey, viewMode === 'week' ? colKey : selectedDay)} className="w-full rounded-lg border-2 border-dashed border-slate-200 dark:border-slate-700 flex items-center justify-center text-slate-300 dark:text-slate-600 hover:border-indigo-300 hover:text-indigo-400 transition-colors mt-auto h-6"><Icon name="Plus" size={16} /></button>}
                                                        </div>
                                                    </td>
                                                );
                                            })}
                                        </tr>
                                    )) : <tr><td colSpan={8} className="p-8 text-center text-slate-400 dark:text-slate-500">Нет данных для отображения</td></tr>}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {!readOnly && <Modal isOpen={isEditorOpen} onClose={() => setIsEditorOpen(false)} title={tempItem.id && data.schedule.find(s=>s.id===tempItem.id) ? "Редактировать урок" : "Добавить урок"}>
                        <div className="space-y-4">
                             {validationWarnings.length > 0 && (
                                <div className="bg-orange-50 dark:bg-orange-900/30 border border-orange-200 dark:border-orange-800 p-3 rounded-xl">
                                    {validationWarnings.map((warn, i) => (
                                        <div key={i} className="text-xs text-orange-700 dark:text-orange-300 font-bold flex items-center gap-2 mb-1 last:mb-0">
                                            <Icon name="AlertTriangle" size={14}/> {warn}
                                        </div>
                                    ))}
                                </div>
                             )}
                             <div className="bg-slate-50 dark:bg-slate-700 p-3 rounded-xl text-xs text-slate-500 dark:text-slate-300 flex gap-4"><span>День: <b>{tempItem.day || selectedDay}</b></span><span>Урок: <b>{tempItem.period}</b></span><span>Смена: <b>{selectedShift}</b></span></div>
                             <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Класс</label>
                                <select className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={tempItem.classId || ''} onChange={e => {
                                    setTempItem({...tempItem, classId: e.target.value});
                                    updateValidation({...tempItem, classId: e.target.value});
                                }}><option value="">Выберите класс</option>{data.classes.filter(c=>c.shift===selectedShift).map(c => <option key={c.id} value={c.id}>{c.name} ({c.studentsCount} уч.)</option>)}</select>
                             </div>
                             
                             <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Предмет</label>
                                <SearchableSelect 
                                    options={data.subjects.map(s => ({ value: s.id, label: s.name + (s.requiredRoomType && s.requiredRoomType !== 'Обычный' ? ` [${s.requiredRoomType}]` : '') }))}
                                    value={tempItem.subjectId}
                                    onChange={(val) => {
                                        setTempItem({...tempItem, subjectId: val, teacherId: ''});
                                        updateValidation({...tempItem, subjectId: val});
                                    }}
                                    placeholder="Выберите предмет"
                                />
                             </div>
                             
                             <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Учитель</label>
                                <SearchableSelect 
                                    options={[
                                        { label: "Рекомендуемые(ведут предмет)", options: recommendedTeachers.map(t => ({ value: t.id, label: t.name })) },
                                        { label: "Остальные", options: otherTeachers.map(t => ({ value: t.id, label: t.name })) }
                                    ]}
                                    value={tempItem.teacherId}
                                    onChange={(val) => setTempItem({...tempItem, teacherId: val})}
                                    placeholder="Выберите учителя"
                                    groupBy={true}
                                />
                             </div>

                             <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Группа / Направление</label><input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="Например: 1 гр. или Профиль" value={tempItem.direction || ''} onChange={e => setTempItem({...tempItem, direction: e.target.value})} /></div>

                             <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Кабинет</label>
                                <select 
                                    className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" 
                                    value={tempItem.roomId || ''} 
                                    onChange={e => {
                                        setTempItem({...tempItem, roomId: e.target.value});
                                        updateValidation({...tempItem, roomId: e.target.value});
                                    }}
                                >
                                    <option value="">Без кабинета</option>
                                    {data.rooms.map(r => (
                                        <option key={r.id} value={r.id}>
                                            {r.name} — {r.capacity} мест [{r.type}]
                                        </option>
                                    ))}
                                    {/* Legacy support for manually typed rooms that are not in the dictionary */}
                                    {tempItem.roomId && !data.rooms.find(r => r.id === tempItem.roomId) && <option value={tempItem.roomId}>{tempItem.roomId} (Текст)</option>}
                                </select>
                             </div>
                             
                             <div className="flex justify-between pt-4 border-t border-slate-100 dark:border-slate-700">{tempItem.id && data.schedule.find(s => s.id === tempItem.id) && <button onClick={() => handleDeleteItem(tempItem.id)} className="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition-colors"><Icon name="Trash2" size={16}/> Удалить</button>}<button onClick={handleSaveItem} className="ml-auto px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-sm font-bold shadow-lg shadow-indigo-200 dark:shadow-none">Сохранить</button></div>
                        </div>
                    </Modal>}

                     {/* PRINT MODAL */}
                    {isPrintModalOpen && (
                        <div className="fixed inset-0 bg-white z-[9999] overflow-auto flex flex-col print-container">
                            <div className="p-6 border-b border-gray-200 flex justify-between items-center no-print bg-gray-50">
                                <h1 className="text-2xl font-bold">Недельное расписание: {printTitle}</h1>
                                <div className="flex gap-4">
                                    <button onClick={() => window.print()} className="bg-indigo-600 text-white px-6 py-2 rounded-lg font-bold flex items-center gap-2 hover:bg-indigo-700">
                                        <Icon name="Printer" size={20} /> Печать
                                    </button>
                                    <button onClick={() => setIsPrintModalOpen(false)} className="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold hover:bg-gray-300">
                                        Закрыть
                                    </button>
                                </div>
                            </div>
                            <div className="p-8">
                                <div className="mb-6 text-center">
                                    <h2 className="text-3xl font-black uppercase mb-1">{printTitle}</h2>
                                    <p className="text-gray-500 font-bold uppercase tracking-widest">Расписание занятий</p>
                                </div>
                                <table className="w-full border-collapse border border-black text-sm">
                                    <thead>
                                        <tr>
                                            <th className="border border-black p-2 bg-gray-100 w-16">Урок</th>
                                            {DAYS.map(day => <th key={day} className="border border-black p-2 bg-gray-100 text-center uppercase">{day}</th>)}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {[1,2,3,4,5,6,7].map(period => (
                                            <tr key={period}>
                                                <td className="border border-black p-2 text-center font-bold bg-gray-50">{period}</td>
                                                {DAYS.map(day => {
                                                    const items = filterId 
                                                        ? data.schedule.filter(s => s.day === day && s.period === period && (
                                                            viewMode === 'teacher' ? s.teacherId === filterId : 
                                                            viewMode === 'subject' ? s.subjectId === filterId : 
                                                            s.classId === filterId
                                                        ))
                                                        : [];
                                                    return (
                                                        <td key={day} className="border border-black p-2 align-top h-20">
                                                            {items.map(item => {
                                                                const s = data.subjects.find(x=>x.id===item.subjectId);
                                                                const c = data.classes.find(x=>x.id===item.classId);
                                                                const t = data.teachers.find(x=>x.id===item.teacherId);
                                                                const r = data.rooms.find(x => x.id === item.roomId);
                                                                const roomName = r ? r.name : item.roomId;

                                                                return (
                                                                    <div key={item.id} className="mb-1 text-xs">
                                                                        <div className="font-bold">
                                                                            {viewMode === 'subject' ? c?.name : s?.name} 
                                                                            {item.direction ? ` (${item.direction})` : ''}
                                                                        </div>
                                                                        <div className="text-gray-600">
                                                                            {viewMode === 'teacher' ? c?.name : 
                                                                             viewMode === 'subject' ? t?.name :
                                                                             t?.name}
                                                                        </div>
                                                                        {roomName && <div className="text-gray-400 italic">Каб. {roomName}</div>}
                                                                    </div>
                                                                );
                                                            })}
                                                        </td>
                                                    );
                                                })}
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        const SubstitutionsPage = () => {
            const { data, saveData } = useData();
            const location = useLocation();
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [currentSubParams, setCurrentSubParams] = useState(null);
            const [absenceModalOpen, setAbsenceModalOpen] = useState(false);
            const [selectedTeacherId, setSelectedTeacherId] = useState(null);
            const [absenceReason, setAbsenceReason] = useState('Болезнь');
            const [showHistory, setShowHistory] = useState(false);
            const [historySearch, setHistorySearch] = useState('');
            const [teacherSearch, setTeacherSearch] = useState('');
            const [teacherShiftFilter, setTeacherShiftFilter] = useState('all');
            const [candidateSearch, setCandidateSearch] = useState('');

            useEffect(() => {
                if(location.state?.subParams) {
                    setCurrentSubParams(location.state.subParams);
                    const item = data.schedule.find(s => s.id === location.state.subParams.scheduleItemId);
                    if (item) {
                        const targetDayIndex = DAYS.indexOf(item.day) + 1; 
                        const today = new Date();
                        const currentDayIndex = today.getDay() || 7;
                        let diff = targetDayIndex - currentDayIndex;
                        if (diff < 0) diff += 7;
                        const nextDate = new Date(today);
                        nextDate.setDate(today.getDate() + diff);
                        setSelectedDate(nextDate.toISOString().split('T')[0]);
                    }
                    setIsModalOpen(true);
                    window.history.replaceState({}, document.title);
                }
            }, [location.state]);

            const selectedDayOfWeek = useMemo(() => { 
                const idx = new Date(selectedDate).getDay(); 
                if (idx === 0 || idx === 6) return null;
                return DAYS[idx - 1]; 
            }, [selectedDate]);

            const filteredTeachersList = useMemo(() => {
                return data.teachers.filter(t => {
                    const matchesSearch = t.name.toLowerCase().includes(teacherSearch.toLowerCase());
                    const matchesShift = teacherShiftFilter === 'all' ? true : t.shifts.includes(teacherShiftFilter);
                    return matchesSearch && matchesShift;
                });
            }, [data.teachers, teacherSearch, teacherShiftFilter]);

            const absentTeachers = data.teachers.filter(t => t.unavailableDates.includes(selectedDate));
            const affectedLessons = useMemo(() => { if (!selectedDayOfWeek) return []; const absentIds = absentTeachers.map(t => t.id); return data.schedule.filter(s => s.day === selectedDayOfWeek && absentIds.includes(s.teacherId)).sort((a, b) => a.period - b.period); }, [data.schedule, selectedDayOfWeek, absentTeachers]);

            const openAbsenceModal = (id) => { setSelectedTeacherId(id); setAbsenceReason('Болезнь'); setAbsenceModalOpen(true); };
            const confirmAbsence = async () => { let list = [...data.teachers]; const t = list.find(x => x.id === selectedTeacherId); if (!t.unavailableDates.includes(selectedDate)) { t.unavailableDates.push(selectedDate); if(!t.absenceReasons) t.absenceReasons = {}; t.absenceReasons[selectedDate] = absenceReason; } await saveData({ ...data, teachers: list }); setAbsenceModalOpen(false); };
            const removeAbsence = async (id) => { let list = [...data.teachers]; const t = list.find(x => x.id === id); t.unavailableDates = t.unavailableDates.filter(d => d !== selectedDate); if(t.absenceReasons) delete t.absenceReasons[selectedDate]; await saveData({ ...data, teachers: list }); };
            const assignSubstitution = async (replacementId) => { if (!currentSubParams) return; let newSubs = [...data.substitutions]; const existingIdx = newSubs.findIndex(s => s.scheduleItemId === currentSubParams.scheduleItemId && s.date === selectedDate); const item = data.schedule.find(s => s.id === currentSubParams.scheduleItemId); const sub = { id: existingIdx >= 0 ? newSubs[existingIdx].id : Math.random().toString(36).substr(2, 9), date: selectedDate, scheduleItemId: currentSubParams.scheduleItemId, originalTeacherId: item.teacherId, replacementTeacherId: replacementId }; if (existingIdx >= 0) newSubs[existingIdx] = sub; else newSubs.push(sub); await saveData({ ...data, substitutions: newSubs }); setIsModalOpen(false); setCandidateSearch(''); };
            const removeSubstitution = async (id) => { const newSubs = data.substitutions.filter(s => !(s.scheduleItemId === id && s.date === selectedDate)); await saveData({ ...data, substitutions: newSubs }); };
            
            const copyForMessenger = () => {
                let text = `*Замены на ${new Date(selectedDate).toLocaleDateString('ru-RU')}*\n`;
                if(affectedLessons.length === 0) {
                    text += "\nЗамен нет.";
                } else {
                    const processShift = (shiftName, shiftEnum) => {
                        const lessons = affectedLessons.filter(l => l.shift === shiftEnum);
                        if (lessons.length > 0) {
                            text += `\n🔹 *${shiftName.toUpperCase()}*\n`;
                            lessons.forEach(l => {
                                const sub = data.substitutions.find(s => s.scheduleItemId === l.id && s.date === selectedDate);
                                const cls = data.classes.find(c => c.id === l.classId);
                                const subj = data.subjects.find(s => s.id === l.subjectId);
                                const rep = sub ? data.teachers.find(t => t.id === sub.replacementTeacherId) : null;
                                const orig = data.teachers.find(t => t.id === l.teacherId);
                                
                                if (rep) text += `✅ ${cls?.name} (${l.period} ур): ${subj?.name} -> ${rep.name} (вместо ${orig?.name})\n`;
                                else text += `❗ ${cls?.name} (${l.period} ур): ${subj?.name} (${orig?.name}) -> УРОК СНЯТ\n`;
                            });
                        }
                    };

                    processShift(Shift.First, Shift.First);
                    processShift(Shift.Second, Shift.Second);
                }

                navigator.clipboard.writeText(text);
                alert("Текст скопирован с разделением по сменам!");
            };

            const generateICal = () => {
                let icalContent = "BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//Gymnasium//Manager//RU\n";
                const subs = data.substitutions.filter(s => s.date === selectedDate);
                subs.forEach(sub => {
                    const item = data.schedule.find(s => s.id === sub.scheduleItemId);
                    if(!item) return;
                    const rep = data.teachers.find(t => t.id === sub.replacementTeacherId);
                    const subj = data.subjects.find(s => s.id === item.subjectId);
                    const cls = data.classes.find(c => c.id === item.classId);
                    const dateStr = sub.date.replace(/-/g, '');
                    icalContent += `BEGIN:VEVENT\nDTSTART;VALUE=DATE:${dateStr}\nSUMMARY:Замена: ${cls.name} - ${subj.name}\nDESCRIPTION:Заменяет: ${rep.name}\nEND:VEVENT\n`;
                });
                icalContent += "END:VCALENDAR";
                const blob = new Blob([icalContent], { type: 'text/calendar' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url; link.download = 'substitutions.ics';
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
            };

            const notifyTeacher = async (replacementTeacher, lessonInfo, classInfo, subjectInfo, roomInfo, dateStr) => {
                const dateObj = new Date(dateStr);
                const formattedDate = dateObj.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
                const shiftText = lessonInfo.shift === Shift.First ? '1 смена' : '2 смена';
                const message = `🔔 *Уведомление о замене*\n${replacementTeacher.name}\n\n📅 Дата: ${formattedDate}\n🕒 Смена: ${shiftText}\n🏫 Класс: ${classInfo?.name}\n1️⃣ Урок: ${lessonInfo.period}\n📚 Предмет: ${subjectInfo?.name}\n🚪 Кабинет: ${roomInfo || 'по расписанию'}`;
                
                if (data.settings?.telegramToken && replacementTeacher.telegramChatId) {
                    try {
                        const response = await fetch(`https://api.telegram.org/bot${data.settings.telegramToken}/sendMessage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ chat_id: replacementTeacher.telegramChatId, text: message, parse_mode: 'Markdown' })
                        });
                        const resData = await response.json();
                        if (resData.ok) {
                            alert(`Сообщение отправлено в Telegram для ${replacementTeacher.name}!`);
                        } else {
                            if (resData.description.includes("chat not found")) {
                                alert(`Ошибка Telegram: Чат не найден.\n\nПопросите учителя ${replacementTeacher.name} найти вашего бота и нажать кнопку "Запустить" (/start).`);
                            } else {
                                alert(`Ошибка Telegram: ${resData.description}`);
                            }
                        }
                    } catch (error) {
                        alert('Ошибка отправки в Telegram (сеть/токен).');
                        console.error(error);
                    }
                } else {
                    if (navigator.share) { navigator.share({ title: 'Замена', text: message }).catch(() => {}); } else { navigator.clipboard.writeText(message); alert(`Сообщение скопировано! (Telegram не настроен или нет Chat ID)`); }
                }
            };

            const candidates = useMemo(() => { 
                if (!currentSubParams || !selectedDayOfWeek) return [];
                const targetMonth = selectedDate.substring(0, 7); 
                return data.teachers
                    .filter(t => t.name.toLowerCase().includes(candidateSearch.toLowerCase()))
                    .map(t => { 
                    const isAbsent = t.unavailableDates.includes(selectedDate); 
                    const isBusy = data.schedule.some(s => s.teacherId === t.id && s.day === selectedDayOfWeek && s.period === currentSubParams.period && s.shift === currentSubParams.shift); 
                    const isSpecialist = t.subjectIds.includes(currentSubParams.subjectId); 
                    const subsCount = data.substitutions.filter(s => s.replacementTeacherId === t.id && s.date.startsWith(targetMonth)).length;
                    let score = 0; 
                    if (isAbsent) score -= 1000; 
                    if (isBusy) score -= 100; 
                    if (isSpecialist) score += 50; 
                    return { teacher: t, isAbsent, isBusy, isSpecialist, score, subsCount }; 
                }).sort((a, b) => {
                    if (b.score !== a.score) return b.score - a.score;
                    return a.subsCount - b.subsCount; 
                }); 
            }, [data, currentSubParams, selectedDate, candidateSearch]);
            
            const modalContext = useMemo(() => {
                if(!currentSubParams) return null;
                const s = data.schedule.find(i => i.id === currentSubParams.scheduleItemId);
                if(!s) return null;
                const c = data.classes.find(cls => cls.id === s.classId);
                const sub = data.subjects.find(subj => subj.id === s.subjectId);
                const t = data.teachers.find(tch => tch.id === s.teacherId);
                return { className: c?.name, subjectName: sub?.name, teacherName: t?.name, period: s.period };
            }, [currentSubParams, data]);

            return (
                <div className="h-full flex flex-col md:flex-row gap-6">
                    <div className="w-full md:w-80 flex flex-col gap-6">
                        <div className="bg-white dark:bg-dark-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                            <label className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2 block">Дата замены</label>
                            <div className="relative"><Icon name="Calendar" className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={18}/><input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="w-full pl-10 border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm font-bold outline-none focus:border-indigo-500 bg-transparent dark:text-white"/></div>
                            <button onClick={() => setShowHistory(!showHistory)} className={`mt-3 w-full py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 border transition-all ${showHistory ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white dark:bg-slate-700 text-indigo-600 dark:text-white border-indigo-200 dark:border-slate-500'}`}><Icon name="History" size={16}/> {showHistory ? 'Скрыть историю' : 'История замен'}</button>
                        </div>
                        
                        {showHistory ? (
                             <div className="bg-white dark:bg-dark-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
                                <h3 className="font-bold text-slate-800 dark:text-slate-100 mb-2">История</h3>
                                <input placeholder="Поиск по дате/учителю..." value={historySearch} onChange={e=>setHistorySearch(e.target.value)} className="mb-4 w-full bg-slate-100 dark:bg-slate-700 border-none rounded-lg p-2 text-xs" />
                                <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                    {data.substitutions.filter(s => s.date.includes(historySearch) || data.teachers.find(t=>t.id===s.replacementTeacherId)?.name.toLowerCase().includes(historySearch.toLowerCase())).map(s => {
                                         const r = data.teachers.find(t=>t.id===s.replacementTeacherId);
                                         return <div key={s.id} className="p-2 border border-slate-100 dark:border-slate-700 rounded-lg text-xs"><div className="font-bold">{s.date}</div><div>{r?.name}</div></div>
                                    })}
                                </div>
                             </div>
                        ) : (
                            <div className="bg-white dark:bg-dark-800 p-5 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex-1 overflow-hidden flex flex-col">
                                <h3 className="font-bold text-slate-800 dark:text-slate-100 mb-4 flex items-center gap-2"><Icon name="UserX" size={18} className="text-red-500"/> Отсутствующие</h3>
                                
                                <div className="mb-3 space-y-2">
                                    <div className="flex bg-slate-100 dark:bg-slate-700 p-1 rounded-lg">
                                        <button onClick={() => setTeacherShiftFilter('all')} className={`flex-1 py-1 text-xs font-bold rounded-md ${teacherShiftFilter === 'all' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Все</button>
                                        <button onClick={() => setTeacherShiftFilter(Shift.First)} className={`flex-1 py-1 text-xs font-bold rounded-md ${teacherShiftFilter === Shift.First ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>1 см</button>
                                        <button onClick={() => setTeacherShiftFilter(Shift.Second)} className={`flex-1 py-1 text-xs font-bold rounded-md ${teacherShiftFilter === Shift.Second ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>2 см</button>
                                    </div>
                                    <div className="relative">
                                        <Icon name="Search" className="absolute left-3 top-2.5 text-slate-400" size={14}/>
                                        <input placeholder="Найти учителя..." value={teacherSearch} onChange={e => setTeacherSearch(e.target.value)} className="w-full pl-8 pr-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-100 dark:border-slate-600 rounded-xl text-xs outline-none focus:ring-1 ring-indigo-500 dark:text-white"/>
                                    </div>
                                </div>

                                <div className="flex-1 overflow-y-auto custom-scrollbar pr-1 space-y-2">
                                    {filteredTeachersList.map(t => {
                                        const isAbsent = t.unavailableDates.includes(selectedDate); const reason = t.absenceReasons ? t.absenceReasons[selectedDate] : '';
                                        return (<div key={t.id} className={`flex flex-col p-3 rounded-xl border transition-all ${isAbsent ? 'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-900' : 'bg-slate-50 dark:bg-slate-700/50 border-slate-100 dark:border-slate-600'}`}><div className="flex items-center justify-between mb-1"><span className={`text-sm font-medium ${isAbsent ? 'text-red-700 dark:text-red-400' : 'text-slate-600 dark:text-slate-300'}`}>{t.name}</span><button onClick={() => isAbsent ? removeAbsence(t.id) : openAbsenceModal(t.id)} className={`text-xs px-2 py-1 rounded-lg font-bold transition-colors ${isAbsent ? 'bg-white dark:bg-dark-800 text-red-600 dark:text-red-400 shadow-sm' : 'text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-600'}`}>{isAbsent ? 'Вернуть' : 'Нет'}</button></div><div className="flex justify-between items-end"><div className="flex gap-1">{t.shifts.map(s => <span key={s} className="text-[9px] bg-white dark:bg-slate-600 px-1 rounded border border-slate-100 dark:border-slate-500 text-slate-400">{s === Shift.First ? '1' : '2'}</span>)}</div>{isAbsent && reason && <div className="text-[10px] text-red-500 dark:text-red-400 italic">{reason}</div>}</div></div>)
                                    })}
                                    {filteredTeachersList.length === 0 && <div className="text-center text-xs text-slate-400 py-4">Не найдено</div>}
                                </div>
                            </div>
                        )}
                    </div>
                    <div className="flex-1 bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 flex flex-col overflow-hidden">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-slate-800 dark:text-slate-100">Требуют замены ({affectedLessons.length})</h2>
                            <div className="flex gap-2">
                                <button onClick={generateICal} className="flex items-center gap-2 px-4 py-2 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 rounded-xl text-sm font-bold hover:bg-blue-100"><Icon name="Calendar" size={16}/> iCal</button>
                                {affectedLessons.length > 0 && <button onClick={copyForMessenger} className="flex items-center gap-2 px-4 py-2 bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-400 rounded-xl text-sm font-bold hover:bg-green-100 dark:hover:bg-green-900/50"><Icon name="Copy" size={16}/> Копировать</button>}
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto custom-scrollbar pr-2 space-y-4">
                            {affectedLessons.length === 0 ? <div className="h-full flex flex-col items-center justify-center text-slate-400"><Icon name="CheckCircle" size={48} className="mb-4 text-slate-200 dark:text-slate-700"/><p>Нет уроков, требующих замены на эту дату</p></div> : affectedLessons.map(l => {
                                const sub = data.substitutions.find(s => s.scheduleItemId === l.id && s.date === selectedDate);
                                const rep = sub ? data.teachers.find(t => t.id === sub.replacementTeacherId) : null; const orig = data.teachers.find(t => t.id === l.teacherId);
                                const subj = data.subjects.find(s => s.id === l.subjectId); const cls = data.classes.find(c => c.id === l.classId);
                                const room = data.rooms.find(r => r.id === l.roomId);
                                const roomName = room ? room.name : l.roomId;
                                
                                return (<div key={l.id} className="p-4 rounded-xl border border-slate-100 dark:border-slate-700 bg-slate-50/50 dark:bg-slate-700/30 flex flex-col xl:flex-row xl:items-center justify-between gap-4"><div className="flex items-center gap-4"><div className="w-12 h-12 bg-white dark:bg-dark-800 rounded-xl shadow-sm border border-slate-200 dark:border-slate-600 flex flex-col items-center justify-center text-indigo-600 dark:text-indigo-400"><span className="text-[10px] font-bold uppercase text-slate-400 leading-none">Урок</span><span className="text-xl font-black leading-none mt-1 dark:text-slate-200">{l.period}</span></div><div><div className="flex items-center gap-2 mb-1"><span className="font-bold text-lg text-slate-800 dark:text-slate-100">{cls?.name}</span><div className="text-sm text-slate-500 dark:text-slate-400 flex items-center gap-2"><span className="text-xs font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-1 rounded">{l.shift === Shift.First ? '1см' : '2см'}</span><span className="text-slate-400">|</span><span>{subj?.name}</span></div></div><div className="text-sm text-slate-600 dark:text-slate-300 flex items-center gap-2"><span className="line-through decoration-red-400 decoration-2">{orig?.name}</span>{roomName && <span className="text-xs bg-white dark:bg-slate-700 px-1.5 py-0.5 rounded border border-slate-200 dark:border-slate-600">{roomName}</span>}</div></div></div>{rep ? (<div className="flex items-center gap-3 bg-emerald-50 dark:bg-emerald-900/20 border border-emerald-100 dark:border-emerald-900 pl-4 pr-2 py-2 rounded-xl"><div><div className="text-[10px] uppercase font-bold text-emerald-600 dark:text-emerald-400 tracking-wider">Замена назначена</div><div className="font-bold text-emerald-900 dark:text-emerald-200 text-sm">{rep.name}</div></div><div className="flex gap-1"><button onClick={() => notifyTeacher(rep, l, cls, subj, roomName, selectedDate)} className="p-2 bg-white dark:bg-dark-800 rounded-lg text-indigo-500 hover:bg-indigo-50 dark:hover:bg-indigo-900/20 transition-colors shadow-sm" title="Отправить уведомление"><Icon name="Send" size={16}/></button><button onClick={() => removeSubstitution(l.id)} className="p-2 bg-white dark:bg-dark-800 rounded-lg text-emerald-200 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors shadow-sm" title="Отменить замену"><Icon name="UserX" size={16}/></button></div></div>) : (<button onClick={() => { setCurrentSubParams({ scheduleItemId: l.id, subjectId: l.subjectId, period: l.period, shift: l.shift }); setIsModalOpen(true); }} className="bg-indigo-600 hover:bg-indigo-700 text-white px-5 py-3 rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 dark:shadow-none transition-all flex items-center justify-center gap-2 xl:w-auto w-full">Найти замену <Icon name="ArrowRight" size={16}/></button>)}</div>)
                            })}
                        </div>
                    </div>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Выбор замены">
                        {modalContext && (
                            <div className="bg-slate-50 dark:bg-slate-700/50 p-3 rounded-xl mb-4 text-sm border border-slate-100 dark:border-slate-600">
                                <div className="font-bold text-slate-700 dark:text-slate-200 mb-1">{modalContext.className} • {modalContext.period} урок</div>
                                <div className="flex justify-between text-slate-500 dark:text-slate-400">
                                    <span>{modalContext.subjectName}</span>
                                    <span className="line-through decoration-red-400">{modalContext.teacherName}</span>
                                </div>
                            </div>
                        )}
                        <div className="relative mb-4">
                            <Icon name="Search" className="absolute left-3 top-2.5 text-slate-400" size={14}/>
                            <input autoFocus placeholder="Поиск учителя..." value={candidateSearch} onChange={e => setCandidateSearch(e.target.value)} className="w-full pl-8 pr-3 py-2 bg-slate-50 dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-xl text-sm outline-none focus:border-indigo-500 dark:text-white"/>
                        </div>
                        <div className="space-y-2 max-h-64 overflow-y-auto custom-scrollbar">
                            {candidates.map(({ teacher, isAbsent, isBusy, isSpecialist, subsCount }) => (
                                <button key={teacher.id} disabled={isAbsent || isBusy} onClick={() => assignSubstitution(teacher.id)} className={`w-full p-3 rounded-xl border flex items-center justify-between transition-all text-left ${isAbsent ? 'bg-red-50 dark:bg-red-900/20 border-red-100 dark:border-red-900 opacity-60' : isBusy ? 'bg-orange-50 dark:bg-orange-900/20 border-orange-100 dark:border-orange-900 opacity-60' : 'bg-white dark:bg-dark-800 border-slate-100 dark:border-slate-700 hover:border-indigo-500 hover:shadow-md'}`}>
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold ${isSpecialist ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-100 dark:bg-slate-700 text-slate-500 dark:text-slate-300'}`}>{isSpecialist ? <Icon name="Star" size={14} fill="currentColor"/> : teacher.name[0]}</div>
                                        <div>
                                            <div className="font-bold text-sm text-slate-800 dark:text-slate-200">{teacher.name}</div>
                                            <div className="text-xs text-slate-500 dark:text-slate-400 mt-1 flex flex-wrap gap-2">
                                                {isSpecialist && <span className="text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 px-1.5 rounded">Профиль</span>}
                                                {isBusy && <span className="text-orange-600 dark:text-orange-400 bg-orange-50 dark:bg-orange-900/20 px-1.5 rounded">Занят</span>}
                                                {isAbsent && <span className="text-red-600 dark:text-red-400 bg-red-50 dark:bg-red-900/20 px-1.5 rounded">Отсутствует</span>}
                                                <span className={`px-1.5 rounded font-medium ${subsCount > 5 ? 'text-amber-600 bg-amber-50 dark:bg-amber-900/20' : 'text-blue-600 bg-blue-50 dark:bg-blue-900/20'}`}>
                                                    В этом мес: {subsCount}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    {!isAbsent && !isBusy && <div className="px-3 py-1 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300 rounded text-xs font-bold">Выбрать</div>}
                                </button>
                            ))}
                            {candidates.length === 0 && <div className="text-center text-slate-400 text-xs py-4">Нет подходящих учителей</div>}
                        </div>
                    </Modal>
                    <Modal isOpen={absenceModalOpen} onClose={() => setAbsenceModalOpen(false)} title="Причина отсутствия"><div className="space-y-4"><select value={absenceReason} onChange={e => setAbsenceReason(e.target.value)} className="w-full border p-3 rounded-xl outline-none font-bold text-slate-700 dark:text-white dark:bg-slate-700 dark:border-slate-600"><option>Болезнь</option><option>Курсы</option><option>Отгул</option><option>Семейные обстоятельства</option><option>Командировка</option></select><div className="flex justify-end"><button onClick={confirmAbsence} className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold">Подтвердить</button></div></div></Modal>
                </div>
            );
        };

        const DirectoryPage = () => {
            const { data, saveData } = useData();
            const [activeTab, setActiveTab] = useState('teachers');
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [teacherForm, setTeacherForm] = useState({ subjectIds: [], shifts: [Shift.First, Shift.Second], telegramChatId: '' });
            const [subjectForm, setSubjectForm] = useState({ color: '#e0e7ff', difficulty: 5, requiredRoomType: 'Обычный' });
            const [classForm, setClassForm] = useState({ shift: Shift.First, studentsCount: 25 });
            const [roomForm, setRoomForm] = useState({ capacity: 30, type: 'Обычный' });
            const [draggedIdx, setDraggedIdx] = useState(null);

            const [activeBellDay, setActiveBellDay] = useState('default');

            const getActiveBells = (shift, period) => {
                const dayKey = activeBellDay;
                let bell = data.bellSchedule.find(b => b.shift === shift && b.period === period && b.day === dayKey);
                if (!bell && dayKey !== 'default') {
                     const defaultBell = data.bellSchedule.find(b => b.shift === shift && b.period === period && b.day === 'default');
                     return defaultBell ? { ...defaultBell, start: '', end: '', isInherited: true } : { start: '', end: '', isInherited: false };
                }
                return bell || { start: '', end: '' };
            };

            const openModal = (id) => {
                setEditingId(id || null);
                if (activeTab === 'teachers') setTeacherForm(id ? data.teachers.find(x => x.id === id) : { subjectIds: [], unavailableDates: [], shifts: [Shift.First, Shift.Second], telegramChatId: '' });
                else if (activeTab === 'subjects') setSubjectForm(id ? data.subjects.find(x => x.id === id) : { color: '#e0e7ff', difficulty: 5, requiredRoomType: 'Обычный' });
                else if (activeTab === 'classes') setClassForm(id ? data.classes.find(x => x.id === id) : { shift: Shift.First, studentsCount: 25 });
                else if (activeTab === 'rooms') setRoomForm(id ? data.rooms.find(x => x.id === id) : { capacity: 30, type: 'Обычный' });
                setIsModalOpen(true);
            };
            const handleSave = async () => {
                const genId = () => Math.random().toString(36).substr(2, 9);
                if (activeTab === 'teachers') { if (!teacherForm.name) return; let list = [...data.teachers]; if (editingId) list = list.map(t => t.id === editingId ? { ...t, ...teacherForm } : t); else list.push({ ...teacherForm, id: genId(), unavailableDates: [] }); await saveData({ ...data, teachers: list }); }
                else if (activeTab === 'subjects') { if (!subjectForm.name) return; let list = [...data.subjects]; if (editingId) list = list.map(s => s.id === editingId ? { ...s, ...subjectForm } : s); else list.push({ ...subjectForm, id: genId() }); await saveData({ ...data, subjects: list }); }
                else if (activeTab === 'classes') { if (!classForm.name) return; let list = [...data.classes]; if (editingId) list = list.map(c => c.id === editingId ? { ...c, ...classForm } : c); else list.push({ ...classForm, id: genId() }); await saveData({ ...data, classes: list }); }
                else if (activeTab === 'rooms') { if (!roomForm.name) return; let list = [...data.rooms]; if (editingId) list = list.map(r => r.id === editingId ? { ...r, ...roomForm } : r); else list.push({ ...roomForm, id: genId() }); await saveData({ ...data, rooms: list }); }
                setIsModalOpen(false);
            };
            const handleDelete = async (id) => { if (!window.confirm("Удалить запись?")) return; if (activeTab === 'teachers') await saveData({ ...data, teachers: data.teachers.filter(t => t.id !== id) }); if (activeTab === 'subjects') await saveData({ ...data, subjects: data.subjects.filter(s => s.id !== id) }); if (activeTab === 'classes') await saveData({ ...data, classes: data.classes.filter(c => c.id !== id) }); if (activeTab === 'rooms') await saveData({ ...data, rooms: data.rooms.filter(r => r.id !== id) }); };
            const onDragStart = (e, index) => { setDraggedIdx(index); e.dataTransfer.effectAllowed = "move"; };
            const onDragOver = (e) => { e.preventDefault(); };
            const onDrop = async (e, index) => { if (draggedIdx === null || draggedIdx === index) return; let list = activeTab === 'teachers' ? [...data.teachers] : activeTab === 'subjects' ? [...data.subjects] : activeTab === 'classes' ? [...data.classes] : [...data.rooms]; const item = list.splice(draggedIdx, 1)[0]; list.splice(index, 0, item); if (activeTab === 'teachers') await saveData({ ...data, teachers: list }); else if (activeTab === 'subjects') await saveData({ ...data, subjects: list }); else if (activeTab === 'classes') await saveData({ ...data, classes: list }); else await saveData({ ...data, rooms: list }); setDraggedIdx(null); };

            const handleBellChange = async (shift, period, field, value) => {
                let bells = [...data.bellSchedule];
                const dayKey = activeBellDay;
                const idx = bells.findIndex(b => b.shift === shift && b.period === period && b.day === dayKey);
                
                if (idx >= 0) {
                    bells[idx] = { ...bells[idx], [field]: value };
                } else {
                    bells.push({ shift, period, [field]: value, start: '00:00', end: '00:00', day: dayKey });
                }
                await saveData({ ...data, bellSchedule: bells });
            };

            const toggleShift = (shift) => {
                const currentShifts = teacherForm.shifts || [];
                if (currentShifts.includes(shift)) {
                    setTeacherForm({ ...teacherForm, shifts: currentShifts.filter(s => s !== shift) });
                } else {
                    setTeacherForm({ ...teacherForm, shifts: [...currentShifts, shift] });
                }
            };

            return (
                <div className="max-w-7xl mx-auto w-full h-full flex flex-col">
                    <div className="flex flex-wrap items-center justify-between gap-4 mb-8 shrink-0">
                        <div className="flex p-1 bg-white dark:bg-dark-800 rounded-xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-x-auto">
                            <button onClick={() => setActiveTab('teachers')} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'teachers' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><Icon name="Users" size={18}/> Учителя</button>
                            <button onClick={() => setActiveTab('subjects')} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'subjects' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><Icon name="BookOpen" size={18}/> Предметы</button>
                            <button onClick={() => setActiveTab('classes')} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'classes' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><Icon name="GraduationCap" size={18}/> Классы</button>
                            <button onClick={() => setActiveTab('rooms')} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'rooms' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><Icon name="DoorOpen" size={18}/> Кабинеты</button>
                            <button onClick={() => setActiveTab('bells')} className={`px-5 py-2.5 rounded-lg text-sm font-bold flex items-center gap-2 transition-all ${activeTab === 'bells' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 shadow-sm' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700'}`}><Icon name="Bell" size={18}/> Звонки</button>
                        </div>
                        {activeTab !== 'bells' && <button onClick={() => openModal()} className="flex items-center gap-2 bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none font-semibold"><Icon name="Plus" size={20} /> Добавить</button>}
                    </div>
                    <div className="flex-1 overflow-y-auto pb-20 custom-scrollbar pr-2">
                        {activeTab === 'teachers' && (<StaggerContainer className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{data.teachers.map((t, i) => (<div key={t.id} draggable onDragStart={(e)=>onDragStart(e,i)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,i)} className="bg-white dark:bg-dark-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm hover:shadow-md transition-all group flex flex-col cursor-grab active:cursor-grabbing"><div className="flex justify-between items-start mb-2"><div className="flex items-center gap-3"><Icon name="GripVertical" className="text-slate-300 dark:text-slate-600" size={16}/><div className="font-bold text-slate-800 dark:text-slate-100 text-lg">{t.name}</div></div><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(t.id)} className="p-2 text-slate-400 hover:text-indigo-600 bg-slate-50 dark:bg-slate-700 rounded-full"><Icon name="Edit2" size={16}/></button><button onClick={() => handleDelete(t.id)} className="p-2 text-slate-400 hover:text-red-600 bg-slate-50 dark:bg-slate-700 rounded-full"><Icon name="Trash2" size={16}/></button></div></div><div className="text-xs text-slate-500 mb-2">{t.birthDate ? `ДР: ${new Date(t.birthDate).toLocaleDateString('ru-RU')}` : ''}</div><div className="flex gap-2 mb-3">{t.shifts?.includes(Shift.First) && <span className="text-[10px] bg-indigo-50 text-indigo-700 px-2 py-0.5 rounded font-bold">1 см</span>}{t.shifts?.includes(Shift.Second) && <span className="text-[10px] bg-purple-50 text-purple-700 px-2 py-0.5 rounded font-bold">2 см</span>}</div><div className="flex flex-wrap gap-1 mt-auto pl-7">{t.subjectIds.map(sid => { const s = data.subjects.find(sub => sub.id === sid); return s ? <span key={sid} className="text-xs px-2 py-1 rounded-md font-medium" style={{backgroundColor: s.color, color: '#334155'}}>{s.name}</span> : null })}</div></div>))}</StaggerContainer>)}
                        {activeTab === 'subjects' && (<StaggerContainer className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">{data.subjects.map((s, i) => (<div key={s.id} draggable onDragStart={(e)=>onDragStart(e,i)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,i)} className="bg-white dark:bg-dark-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between group cursor-grab active:cursor-grabbing border-l-4" style={{borderLeftColor: s.color}}><div className="flex items-center gap-3"><Icon name="GripVertical" className="text-slate-300 dark:text-slate-600" size={16}/><div><div className="font-bold text-slate-700 dark:text-slate-200">{s.name}</div><div className="text-xs text-slate-400">Сложность: {s.difficulty} • {s.requiredRoomType}</div></div></div><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(s.id)} className="p-1.5 text-slate-400 hover:text-indigo-600"><Icon name="Edit2" size={16}/></button><button onClick={() => handleDelete(s.id)} className="p-1.5 text-slate-400 hover:text-red-600"><Icon name="Trash2" size={16}/></button></div></div>))}</StaggerContainer>)}
                        {activeTab === 'classes' && (<StaggerContainer className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">{data.classes.map((c, i) => (<div key={c.id} draggable onDragStart={(e)=>onDragStart(e,i)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,i)} className="bg-white dark:bg-dark-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm text-center group hover:shadow-md transition-all relative cursor-grab active:cursor-grabbing"><div className="absolute left-2 top-2 text-slate-300 dark:text-slate-600"><Icon name="GripVertical" size={14}/></div><div className="text-2xl font-black text-slate-800 dark:text-slate-100 mb-1">{c.name}</div><div className="text-xs text-slate-500 mb-1">{c.studentsCount || 0} учеников</div><div className={`text-xs font-bold px-2 py-0.5 rounded-full inline-block ${c.shift === Shift.First ? 'bg-blue-50 text-blue-600' : 'bg-orange-50 text-orange-600'}`}>{c.shift === Shift.First ? 'I' : 'II'} смена</div><div className="absolute top-2 right-2 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(c.id)} className="p-1 text-slate-400 hover:text-indigo-600"><Icon name="Edit2" size={14}/></button><button onClick={() => handleDelete(c.id)} className="p-1 text-slate-400 hover:text-red-600"><Icon name="Trash2" size={14}/></button></div></div>))}</StaggerContainer>)}
                        {activeTab === 'rooms' && (<StaggerContainer className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">{data.rooms.map((r, i) => (<div key={r.id} draggable onDragStart={(e)=>onDragStart(e,i)} onDragOver={onDragOver} onDrop={(e)=>onDrop(e,i)} className="bg-white dark:bg-dark-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center justify-between group cursor-grab active:cursor-grabbing"><div className="flex items-center gap-3"><Icon name="GripVertical" className="text-slate-300 dark:text-slate-600" size={16}/><div className="bg-indigo-50 dark:bg-indigo-900/30 p-2 rounded-lg text-indigo-600"><Icon name="DoorOpen" size={20}/></div><div><div className="font-bold text-slate-700 dark:text-slate-200">{r.name}</div><div className="text-xs text-slate-400">Вмест: {r.capacity} • {r.type}</div></div></div><div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"><button onClick={() => openModal(r.id)} className="p-1.5 text-slate-400 hover:text-indigo-600"><Icon name="Edit2" size={16}/></button><button onClick={() => handleDelete(r.id)} className="p-1.5 text-slate-400 hover:text-red-600"><Icon name="Trash2" size={16}/></button></div></div>))}</StaggerContainer>)}

                        {activeTab === 'bells' && (
                            <div className="flex flex-col gap-6">
                                <div className="flex justify-center">
                                    <div className="bg-slate-100 dark:bg-slate-700 p-1 rounded-xl flex gap-1">
                                        <button onClick={() => setActiveBellDay('default')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeBellDay === 'default' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Стандартное</button>
                                        <button onClick={() => setActiveBellDay('Ср')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeBellDay === 'Ср' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Среда</button>
                                        <button onClick={() => setActiveBellDay('Чт')} className={`px-6 py-2 rounded-lg text-sm font-bold transition-all ${activeBellDay === 'Чт' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Четверг</button>
                                    </div>
                                </div>
                                <div className="text-center text-xs text-slate-400 -mt-3">
                                    {activeBellDay === 'default' ? 'Применяется ко всем дням, кроме Ср и Чт' : `Применяется только в ${activeBellDay === 'Ср' ? 'Среду' : 'Четверг'}`}
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    {[Shift.First, Shift.Second].map(shift => (
                                        <div key={shift} className="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden">
                                            <div className={`p-4 font-bold text-lg text-white ${shift === Shift.First ? 'bg-indigo-600' : 'bg-purple-600'}`}>
                                                {shift}
                                            </div>
                                            <div className="p-6 space-y-3">
                                                {SHIFT_PERIODS[shift].map(period => {
                                                    const bell = getActiveBells(shift, period);
                                                    return (
                                                        <div key={period} className={`flex items-center gap-4 p-2 rounded-xl transition-colors ${bell.isInherited ? 'bg-slate-50/50 dark:bg-slate-800/50 opacity-60' : 'bg-slate-50 dark:bg-slate-700/50'}`}>
                                                            <div className="w-10 h-10 rounded-lg bg-white dark:bg-slate-600 flex items-center justify-center font-black text-slate-500 dark:text-slate-300 shadow-sm">{period}</div>
                                                            <div className="flex-1 flex items-center gap-2">
                                                                <input type="time" placeholder="--:--" className="flex-1 border-none bg-transparent font-bold text-slate-800 dark:text-white text-center focus:ring-0" value={bell.start} onChange={e => handleBellChange(shift, period, 'start', e.target.value)} />
                                                                <span className="text-slate-300">—</span>
                                                                <input type="time" placeholder="--:--" className="flex-1 border-none bg-transparent font-bold text-slate-800 dark:text-white text-center focus:ring-0" value={bell.end} onChange={e => handleBellChange(shift, period, 'end', e.target.value)} />
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                    <Modal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} title="Редактирование">
                        <div className="space-y-4">
                            {activeTab === 'teachers' && (<>
                                <input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="ФИО Учителя" value={teacherForm.name || ''} onChange={e => setTeacherForm({...teacherForm, name: e.target.value})} />
                                <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Дата рождения</label><input type="date" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={teacherForm.birthDate || ''} onChange={e => setTeacherForm({...teacherForm, birthDate: e.target.value})} /></div>
                                
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Telegram Chat ID</label>
                                    <input type="text" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={teacherForm.telegramChatId || ''} onChange={e => setTeacherForm({...teacherForm, telegramChatId: e.target.value})} placeholder="12345678" />
                                    <p className="text-[10px] text-slate-400 mt-1">Учитель должен найти вашего бота и нажать <b>/start</b>, иначе сообщения не дойдут.</p>
                                </div>

                                <div className="space-y-2">
                                    <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase">Смены</div>
                                    <div className="flex gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" checked={teacherForm.shifts?.includes(Shift.First)} onChange={() => toggleShift(Shift.First)} /><span className="text-sm font-medium dark:text-slate-300">1 смена</span></label>
                                        <label className="flex items-center gap-2 cursor-pointer"><input type="checkbox" className="rounded text-purple-600 focus:ring-purple-500" checked={teacherForm.shifts?.includes(Shift.Second)} onChange={() => toggleShift(Shift.Second)} /><span className="text-sm font-medium dark:text-slate-300">2 смена</span></label>
                                    </div>
                                </div>
                                <div className="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mt-2">Предметы</div>
                                <div className="grid grid-cols-2 gap-2 max-h-48 overflow-y-auto custom-scrollbar border border-slate-100 dark:border-slate-700 p-2 rounded-xl">{data.subjects.map(s => (<label key={s.id} className="flex items-center gap-2 p-1 rounded hover:bg-slate-50 dark:hover:bg-slate-700 cursor-pointer"><input type="checkbox" className="rounded text-indigo-600 focus:ring-indigo-500" checked={teacherForm.subjectIds?.includes(s.id)} onChange={e => { const current = teacherForm.subjectIds || []; setTeacherForm({...teacherForm, subjectIds: e.target.checked ? [...current, s.id] : current.filter(x => x !== s.id)}); }} /><span className="text-sm dark:text-slate-300">{s.name}</span></label>))}</div>
                            </>)}
                            
                            {activeTab === 'subjects' && (<>
                                <input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="Название предмета" value={subjectForm.name || ''} onChange={e => setSubjectForm({...subjectForm, name: e.target.value})} />
                                <div className="flex items-center gap-4"><span className="text-sm font-bold text-slate-600 dark:text-slate-300">Цвет:</span><input type="color" className="w-20 h-10 cursor-pointer bg-transparent" value={subjectForm.color || '#ffffff'} onChange={e => setSubjectForm({...subjectForm, color: e.target.value})} /></div>
                                <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Сложность (СанПиН 1-12)</label><input type="number" min="1" max="12" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={subjectForm.difficulty || 5} onChange={e => setSubjectForm({...subjectForm, difficulty: parseInt(e.target.value)})} /></div>
                                <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Требуемый тип кабинета</label><select className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={subjectForm.requiredRoomType} onChange={e => setSubjectForm({...subjectForm, requiredRoomType: e.target.value})}>{ROOM_TYPES.map(type => <option key={type} value={type}>{type}</option>)}</select></div>
                            </>)}

                            {activeTab === 'classes' && (<>
                                <input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="Название класса (5А)" value={classForm.name || ''} onChange={e => setClassForm({...classForm, name: e.target.value})} />
                                <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Количество учеников</label><input type="number" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={classForm.studentsCount || 25} onChange={e => setClassForm({...classForm, studentsCount: parseInt(e.target.value)})} /></div>
                                <div className="grid grid-cols-2 gap-3"><button onClick={() => setClassForm({...classForm, shift: Shift.First})} className={`p-3 rounded-xl border text-sm font-bold transition-all ${classForm.shift === Shift.First ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400'}`}>1 смена</button><button onClick={() => setClassForm({...classForm, shift: Shift.Second})} className={`p-3 rounded-xl border text-sm font-bold transition-all ${classForm.shift === Shift.Second ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400' : 'border-slate-200 dark:border-slate-600 text-slate-500 dark:text-slate-400'}`}>2 смена</button></div>
                            </>)}

                            {activeTab === 'rooms' && (<>
                                <input className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" placeholder="Номер/Название (напр. 101)" value={roomForm.name || ''} onChange={e => setRoomForm({...roomForm, name: e.target.value})} />
                                <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Вместимость (мест)</label><input type="number" className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={roomForm.capacity || 30} onChange={e => setRoomForm({...roomForm, capacity: parseInt(e.target.value)})} /></div>
                                <div><label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-1">Тип кабинета</label><select className="w-full border border-slate-200 dark:border-slate-600 rounded-xl p-3 text-sm bg-white dark:bg-slate-700 dark:text-white outline-none focus:border-indigo-500" value={roomForm.type} onChange={e => setRoomForm({...roomForm, type: e.target.value})}>{ROOM_TYPES.map(type => <option key={type} value={type}>{type}</option>)}</select></div>
                            </>)}

                            <div className="flex justify-end pt-4"><button onClick={handleSave} className="px-6 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 text-sm font-bold shadow-lg shadow-indigo-200 dark:shadow-none">Сохранить</button></div>
                        </div>
                    </Modal>
                </div>
            );
        };
        
        const AdminPage = () => {
            const { data, saveData } = useData();
            const [activeTab, setActiveTab] = useState('teachers');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            
            const [teacherShift, setTeacherShift] = useState(Shift.First);
            const [afterPeriod, setAfterPeriod] = useState(1);
            const [roomShift, setRoomShift] = useState(Shift.First);
            const [roomPeriod, setRoomPeriod] = useState(1);

            const [telegramToken, setTelegramToken] = useState(data.settings?.telegramToken || '');

            useEffect(() => {
                setAfterPeriod(teacherShift === Shift.First ? 1 : 0);
            }, [teacherShift]);

            useEffect(() => {
                setRoomPeriod(roomShift === Shift.First ? 1 : 0);
            }, [roomShift]);

            const selectedDayOfWeek = useMemo(() => {
                const idx = new Date(selectedDate).getDay();
                if (idx === 0 || idx === 6) return null;
                return DAYS[idx - 1];
            }, [selectedDate]);

            const periodsForShift = SHIFT_PERIODS[teacherShift];

            const freeTeachers = useMemo(() => {
                if (!selectedDayOfWeek) return [];
                return data.teachers.filter(teacher => {
                    if (teacher.shifts && !teacher.shifts.includes(teacherShift)) return false;
                    if (teacher.unavailableDates.includes(selectedDate)) return false;
                    const hasLateLessons = data.schedule.some(s => 
                        s.teacherId === teacher.id && 
                        s.day === selectedDayOfWeek && 
                        s.period > afterPeriod && 
                        s.shift === teacherShift
                    );
                    return !hasLateLessons;
                }).sort((a, b) => a.name.localeCompare(b.name));
            }, [data, selectedDate, selectedDayOfWeek, afterPeriod, teacherShift]);

            const freeRooms = useMemo(() => {
                if (!selectedDayOfWeek) return [];
                const occupiedRoomIds = new Set();
                data.schedule.forEach(s => {
                    if (s.day === selectedDayOfWeek && s.period === roomPeriod && s.shift === roomShift && s.roomId) {
                        occupiedRoomIds.add(s.roomId);
                    }
                });
                const availableDictRooms = data.rooms.filter(r => !occupiedRoomIds.has(r.id)).map(r => r.name);
                return availableDictRooms;
            }, [data.schedule, data.rooms, selectedDayOfWeek, roomPeriod, roomShift]);

            const saveSettings = async () => {
                await saveData({ ...data, settings: { ...data.settings, telegramToken } });
                alert("Настройки сохранены!");
            };

            return (
                <div className="max-w-5xl mx-auto w-full">
                    <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-8">
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-6 mb-6">
                            <h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-3">
                                <Icon name="Settings" className="text-indigo-600 dark:text-indigo-400" />
                                Администрация и Поиск
                            </h1>
                             <div className="flex gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                <button onClick={() => setActiveTab('teachers')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'teachers' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>Учителя</button>
                                <button onClick={() => setActiveTab('rooms')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'rooms' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>Кабинеты</button>
                                <button onClick={() => setActiveTab('settings')} className={`px-4 py-2 rounded-lg text-sm font-bold transition-all ${activeTab === 'settings' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>Настройки</button>
                            </div>
                        </div>

                        {activeTab !== 'settings' && (
                             <div className="mb-6">
                                 <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Дата</label>
                                 <input type="date" value={selectedDate} onChange={e => setSelectedDate(e.target.value)} className="border border-slate-200 dark:border-slate-600 p-3 rounded-xl font-bold outline-none focus:border-indigo-500 bg-transparent dark:text-white w-full md:w-auto" />
                             </div>
                        )}
                        
                        {activeTab === 'teachers' && (
                            <div className="flex flex-wrap gap-6">
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Смена</label>
                                    <div className="flex gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                        <button onClick={() => setTeacherShift(Shift.First)} className={`px-3 py-2 rounded-lg text-sm font-bold transition-all ${teacherShift === Shift.First ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>1 смена</button>
                                        <button onClick={() => setTeacherShift(Shift.Second)} className={`px-3 py-2 rounded-lg text-sm font-bold transition-all ${teacherShift === Shift.Second ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>2 смена</button>
                                    </div>
                                 </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Свободен после урока №</label>
                                    <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl w-fit">
                                        {periodsForShift.map(num => (
                                            <button key={num} onClick={() => setAfterPeriod(num)} className={`w-10 h-10 rounded-lg font-bold text-sm transition-all ${afterPeriod === num ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>{num}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'rooms' && (
                            <div className="flex flex-wrap gap-6">
                                 <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Смена</label>
                                    <div className="flex gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl">
                                        <button onClick={() => setRoomShift(Shift.First)} className={`px-3 py-2 rounded-lg text-sm font-bold transition-all ${roomShift === Shift.First ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>1 смена</button>
                                        <button onClick={() => setRoomShift(Shift.Second)} className={`px-3 py-2 rounded-lg text-sm font-bold transition-all ${roomShift === Shift.Second ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>2 смена</button>
                                    </div>
                                 </div>
                                 <div>
                                    <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Урок №</label>
                                    <div className="flex items-center gap-1 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl w-fit">
                                        {SHIFT_PERIODS[roomShift].map(num => (
                                            <button key={num} onClick={() => setRoomPeriod(num)} className={`w-10 h-10 rounded-lg font-bold text-sm transition-all ${roomPeriod === num ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400 hover:text-slate-700'}`}>{num}</button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'settings' && (
                            <div>
                                <label className="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-2">Telegram Bot Token</label>
                                <input type="password" value={telegramToken} onChange={e => setTelegramToken(e.target.value)} className="w-full border border-slate-200 dark:border-slate-600 p-3 rounded-xl text-sm outline-none dark:bg-slate-700 dark:text-white mb-4" placeholder="123456789:ABCDefGhIjkLmNoPqRsTuVwXyZ" />
                                <p className="text-xs text-slate-400 mb-4">Получите токен у @BotFather. Учителя должны будут запустить этого бота командой <b>/start</b>, чтобы получать уведомления.</p>
                                <button onClick={saveSettings} className="bg-indigo-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-indigo-700 transition">Сохранить</button>
                            </div>
                        )}
                    </div>

                    {activeTab === 'teachers' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {freeTeachers.map(t => (
                                <div key={t.id} className="bg-white dark:bg-dark-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center gap-4 hover:shadow-md transition-all">
                                    <div className="w-12 h-12 rounded-full bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 flex items-center justify-center">
                                        <Icon name="CheckCircle" size={24} />
                                    </div>
                                    <div>
                                        <div className="font-bold text-slate-800 dark:text-slate-200">{t.name}</div>
                                        <div className="flex flex-wrap gap-1 mt-1">
                                            {t.subjectIds.slice(0, 2).map(sid => {
                                                const s = data.subjects.find(sub => sub.id === sid);
                                                return s ? <span key={sid} className="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 dark:bg-slate-700 text-slate-600 dark:text-slate-300">{s.name}</span> : null
                                            })}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {freeTeachers.length === 0 && <div className="col-span-full py-12 text-center text-slate-400">Не найдено учителей, свободных после {afterPeriod} урока в {teacherShift}</div>}
                        </div>
                    )}

                     {activeTab === 'rooms' && (
                        <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                            {freeRooms.map(roomName => (
                                <div key={roomName} className="bg-white dark:bg-dark-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm text-center flex flex-col items-center justify-center hover:border-indigo-500 transition-all">
                                    <Icon name="DoorOpen" size={24} className="text-emerald-500 mb-2"/>
                                    <div className="text-xl font-black text-slate-800 dark:text-white">{roomName}</div>
                                    <div className="text-xs text-slate-500 dark:text-slate-400 font-bold uppercase">Свободен</div>
                                </div>
                            ))}
                            {freeRooms.length === 0 && (
                                <div className="col-span-full py-12 text-center text-slate-400">
                                    <Icon name="AlertTriangle" size={48} className="mx-auto mb-4 text-slate-300 dark:text-slate-600"/>
                                    <p>Нет свободных кабинетов в это время (или расписание не заполнено).</p>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };
        
        const ReportsPage = () => {
            const { data } = useData();
            const [reportTab, setReportTab] = useState('load');
            const [selectedClassId, setSelectedClassId] = useState(data.classes[0]?.id || '');
            const getTariffication = () => { const weeks = 4; return data.teachers.map(t => { const weeklyLessons = data.schedule.filter(s => s.teacherId === t.id); const weeklyHours = weeklyLessons.length; const monthlyPlan = weeklyHours * weeks; const subsTaken = data.substitutions.filter(s => s.replacementTeacherId === t.id).length; const subsMissed = data.substitutions.filter(s => s.originalTeacherId === t.id).length; const absenceDays = t.unavailableDates.length; const actualHours = monthlyPlan + subsTaken - subsMissed; const subjectBreakdown = {}; weeklyLessons.forEach(s => { const subj = data.subjects.find(sub => sub.id === s.subjectId); if(subj) subjectBreakdown[subj.name] = (subjectBreakdown[subj.name] || 0) + 1; }); return { id: t.id, name: t.name, weeklyHours, subsTaken, subsMissed, actualHours, subjectBreakdown }; }).sort((a,b) => b.actualHours - a.actualHours); };
            const getSanPinData = () => { if(!selectedClassId) return []; return DAYS.map(day => { const lessons = data.schedule.filter(s => s.classId === selectedClassId && s.day === day); const score = lessons.reduce((acc, curr) => { const subj = data.subjects.find(s => s.id === curr.subjectId); return acc + (subj?.difficulty || 5); }, 0); return { label: day, value: score }; }); };
            const getRatings = () => { const heroes = data.teachers.map(t => ({ name: t.name, count: data.substitutions.filter(s => s.replacementTeacherId === t.id).length })).sort((a,b) => b.count - a.count).slice(0, 5); const absentees = data.teachers.map(t => ({ name: t.name, count: t.unavailableDates.length })).sort((a,b) => b.count - a.count).slice(0, 5); return { heroes, absentees }; };
            const tariffData = getTariffication(); const sanPinData = getSanPinData(); const ratings = getRatings();
            const downloadReport = () => { let csv = ""; if (reportTab === 'load') { csv = "Teacher,Planned Weekly,Subs Taken,Absences (Lessons),Est. Monthly Actual,Details\n" + tariffData.map(r => `${r.name},${r.weeklyHours},${r.subsTaken},${r.subsMissed},${r.actualHours},"${Object.entries(r.subjectBreakdown).map(([k,v]) => k+': '+v).join(', ')}"`).join('\n'); } else if (reportTab === 'sanpin') { csv = "Day,Score\n" + sanPinData.map(r => `${r.label},${r.value}`).join('\n'); } const link = document.createElement("a"); link.href = 'data:text/csv;charset=utf-8,' + encodeURI(csv); link.download = `report_${reportTab}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); };

            return (
                <div className="max-w-6xl mx-auto w-full pb-20">
                    <div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 mb-6"><div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6"><h1 className="text-2xl font-bold text-slate-800 dark:text-white flex items-center gap-3"><Icon name="BarChart2" className="text-indigo-600 dark:text-indigo-400" /> Аналитика</h1><button onClick={downloadReport} className="px-4 py-2 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 rounded-lg text-sm font-bold flex items-center gap-2"><Icon name="FileSpreadsheet" size={16}/> Скачать CSV</button></div><div className="flex gap-2 bg-slate-100 dark:bg-slate-700 p-1 rounded-xl w-fit overflow-x-auto max-w-full"><button onClick={() => setReportTab('load')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${reportTab === 'load' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Тарификация (Нагрузка)</button><button onClick={() => setReportTab('sanpin')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${reportTab === 'sanpin' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>СанПиН (Сложность)</button><button onClick={() => setReportTab('rating')} className={`px-4 py-2 rounded-lg text-sm font-bold whitespace-nowrap transition-all ${reportTab === 'rating' ? 'bg-white dark:bg-slate-600 shadow text-indigo-600 dark:text-white' : 'text-slate-500 dark:text-slate-400'}`}>Рейтинг замен</button></div></div>
                    {reportTab === 'load' && (<div className="bg-white dark:bg-dark-800 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700 overflow-hidden"><table className="w-full text-left border-collapse"><thead className="bg-slate-50 dark:bg-slate-700 border-b border-slate-200 dark:border-slate-600"><tr><th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase">Учитель</th><th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase text-right">План (Нед)</th><th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase text-right text-emerald-600">+ Замены</th><th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase text-right text-red-500">- Пропуски</th><th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase text-right">Итого (Мес)</th><th className="p-4 font-bold text-slate-500 dark:text-slate-400 text-xs uppercase w-1/3">Детализация</th></tr></thead><tbody className="divide-y divide-slate-100 dark:divide-slate-700">{tariffData.map(row => (<tr key={row.id} className="hover:bg-slate-50 dark:hover:bg-slate-700/50"><td className="p-4 font-bold text-slate-800 dark:text-slate-200">{row.name}</td><td className="p-4 text-right font-mono">{row.weeklyHours}</td><td className="p-4 text-right font-mono text-emerald-600 font-bold">+{row.subsTaken}</td><td className="p-4 text-right font-mono text-red-500 font-bold">-{row.subsMissed}</td><td className="p-4 text-right font-mono font-black text-lg">{row.actualHours}</td><td className="p-4 text-xs text-slate-500 dark:text-slate-400"><div className="flex flex-wrap gap-1">{Object.entries(row.subjectBreakdown).map(([s,c]) => (<span key={s} className="bg-slate-100 dark:bg-slate-600 px-1.5 py-0.5 rounded">{s}: {c}</span>))}</div></td></tr>))}</tbody></table></div>)}
                    {reportTab === 'sanpin' && (<div className="grid grid-cols-1 lg:grid-cols-3 gap-6"><div className="lg:col-span-2 bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700"><div className="flex justify-between items-center mb-6"><h3 className="font-bold text-lg dark:text-white">График сложности</h3><select value={selectedClassId} onChange={e => setSelectedClassId(e.target.value)} className="border dark:border-slate-600 p-2 rounded-lg bg-transparent dark:text-white outline-none">{data.classes.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}</select></div><BarChart items={sanPinData} max={60} color="indigo"/><div className="mt-4 text-xs text-slate-500 dark:text-slate-400">* Баллы рассчитываются на основе шкалы трудности предметов (Математика=11, и т.д.). Рекомендуемый пик нагрузки: Среда/Четверг.</div></div><div className="bg-indigo-50 dark:bg-indigo-900/20 p-6 rounded-2xl border border-indigo-100 dark:border-indigo-900"><h3 className="font-bold text-indigo-900 dark:text-indigo-300 mb-4">Нормы СанПиН</h3><ul className="space-y-3 text-sm text-indigo-800 dark:text-indigo-400"><li className="flex gap-2"><div className="w-1.5 h-1.5 mt-1.5 bg-indigo-500 rounded-full"></div>Равномерное распределение нагрузки</li><li className="flex gap-2"><div className="w-1.5 h-1.5 mt-1.5 bg-indigo-500 rounded-full"></div>Один сложный предмет в день</li><li className="flex gap-2"><div className="w-1.5 h-1.5 mt-1.5 bg-indigo-500 rounded-full"></div>Контрольные работы в Вт/Ср</li></ul></div></div>)}
                    {reportTab === 'rating' && (<div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700"><h3 className="font-bold text-lg text-emerald-600 mb-4 flex items-center gap-2"><Icon name="TrendingUp" size={20}/> Герои замен (Топ 5)</h3><BarChart items={ratings.heroes.map(h => ({ label: h.name, value: h.count }))} max={Math.max(...ratings.heroes.map(h=>h.count), 1)} color="emerald"/></div><div className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700"><h3 className="font-bold text-lg text-red-500 mb-4 flex items-center gap-2"><Icon name="Activity" size={20}/> Пропуски (Топ 5)</h3><BarChart items={ratings.absentees.map(h => ({ label: h.name, value: h.count }))} max={Math.max(...ratings.absentees.map(h=>h.count), 1)} color="red"/></div></div>)}
                </div>
            );
        };

        const ExportPage = () => {
            const { data, saveData, resetData } = useData();
            const fileInputRef = useRef(null);
            const printRef = useRef(null);
            const [exportDate, setExportDate] = useState(new Date().toISOString().split('T')[0]);
            const [isGenerating, setIsGenerating] = useState(false);
            const handleImport = (e) => { 
                const file = e.target.files?.[0]; 
                if (!file) return; 
                const reader = new FileReader(); 
                reader.onload = async (ev) => { 
                    try { 
                        const json = JSON.parse(ev.target.result); 
                        if (json.teachers && json.schedule) { 
                            if(window.confirm("Это перезапишет текущую базу данных. Продолжить?")) { 
                                const mergedData = {
                                    ...INITIAL_DATA,
                                    ...json,
                                    rooms: json.rooms || INITIAL_DATA.rooms,
                                    classes: json.classes || [],
                                    schedule: json.schedule || [],
                                    teachers: json.teachers || [],
                                    subjects: json.subjects || [],
                                    substitutions: json.substitutions || [],
                                    settings: json.settings || { telegramToken: '' }
                                };
                                await saveData(mergedData); 
                                alert("База успешно восстановлена!"); 
                            } 
                        } else alert("Неверный формат файла."); 
                    } catch (err) { alert("Ошибка чтения файла."); } 
                }; 
                reader.readAsText(file); 
            };
            
            const exportStyledExcel = () => {
                let html = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head><meta charset="UTF-8"><style>
                        table { border-collapse: collapse; width: 100%; font-family: Arial, sans-serif; }
                        td, th { border: 1px solid #999; padding: 5px; vertical-align: top; }
                        .header { background-color: #f3f4f6; font-weight: bold; text-align: center; }
                        .class-cell { font-size: 14px; font-weight: bold; text-align: center; vertical-align: middle; }
                        .subject { font-weight: bold; font-size: 11px; }
                        .meta { font-size: 10px; color: #555; }
                    </style></head><body><table>
                `;

                DAYS.forEach(day => {
                    html += `<tr><td colspan="8" style="background-color:#4f46e5; color:white; font-size:16px; font-weight:bold; text-align:center;">${day}</td></tr>`;
                    [Shift.First, Shift.Second].forEach(shift => {
                        const classes = data.classes.filter(c => c.shift === shift);
                        if (classes.length === 0) return;
                        
                        html += `<tr><td colspan="8" style="background-color:#e0e7ff; font-weight:bold;">${shift}</td></tr>`;
                        html += `<tr><th class="header">Класс</th>`;
                        SHIFT_PERIODS[shift].forEach(p => html += `<th class="header">${p} урок</th>`);
                        html += `</tr>`;

                        classes.forEach(c => {
                            html += `<tr><td class="class-cell">${c.name}</td>`;
                            SHIFT_PERIODS[shift].forEach(p => {
                                const items = data.schedule.filter(s => s.classId === c.id && s.day === day && s.shift === shift && s.period === p);
                                html += `<td style="height: 60px;">`;
                                items.forEach(item => {
                                    const sub = data.subjects.find(s => s.id === item.subjectId);
                                    const teach = data.teachers.find(t => t.id === item.teacherId);
                                    const room = data.rooms.find(r => r.id === item.roomId);
                                    const roomName = room ? room.name : item.roomId;
                                    html += `<div style="background-color: ${sub?.color || '#fff'}; padding: 2px; margin-bottom: 2px; border: 1px solid #eee;">
                                        <div class="subject">${sub?.name || ''} ${item.direction || ''}</div>
                                        <div class="meta">${teach?.name || ''} ${roomName ? `(Каб. ${roomName})` : ''}</div>
                                    </div>`;
                                });
                                html += `</td>`;
                            });
                            html += `</tr>`;
                        });
                    });
                });
                
                html += `</table></body></html>`;
                const blob = new Blob([html], { type: "application/vnd.ms-excel" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Расписание_Гимназия22.xls`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const exportMatrixExcel = () => {
                let html = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
                    <head><meta charset="UTF-8"><style>
                        table { border-collapse: collapse; font-family: Arial, sans-serif; font-size: 12px; margin-bottom: 20px; }
                        td, th { border: 1px solid #000; padding: 2px; vertical-align: middle; text-align: center; }
                        .header { font-weight: bold; background-color: #f3f4f6; }
                        .subject-cell { font-weight: bold; vertical-align: middle; background-color: #fff; }
                        .teacher-cell { text-align: left; padding-left: 5px; }
                        sub { font-size: 9px; vertical-align: sub; }
                    </style></head><body>
                `;

                [Shift.First, Shift.Second].forEach(shift => {
                    const periods = SHIFT_PERIODS[shift];
                    
                    html += `<table>`;
                    html += `<tr>
                        <th rowspan="3" class="header" style="border: 2px solid #000; width: 150px;">Учебный предмет</th>
                        <th rowspan="3" class="header" style="border: 2px solid #000; width: 200px;">ФИО</th>
                        <th colspan="${DAYS.length * periods.length}" class="header" style="border: 2px solid #000; font-size: 14px;">День недели</th>
                    </tr>`;

                    html += `<tr>`;
                    DAYS.forEach(day => {
                        html += `<th colspan="${periods.length}" class="header" style="border: 2px solid #000;">${day}</th>`;
                    });
                    html += `</tr>`;

                    html += `<tr>`;
                    DAYS.forEach(() => {
                        html += `<th colspan="${periods.length}" class="header" style="border-bottom: 2px solid #000;">Урок</th>`;
                    });
                    html += `</tr>`;
                    
                    html += `<tr>
                        <th class="header" style="border: 2px solid #000; background-color: #e0e7ff;">${shift}</th>
                        <th class="header" style="border: 2px solid #000;"></th>
                    `;
                    DAYS.forEach(() => {
                        periods.forEach(p => html += `<th class="header" style="width: 40px;">${p}</th>`);
                    });
                    html += `</tr>`;

                    data.subjects.forEach(subject => {
                        const teachers = data.teachers.filter(t => t.subjectIds.includes(subject.id));
                        if (teachers.length === 0) return;

                        const subjectColor = subject.color || '#ffffff';

                        teachers.forEach((teacher, tIndex) => {
                            html += `<tr>`;
                            if (tIndex === 0) {
                                html += `<td rowspan="${teachers.length}" class="subject-cell" style="border: 2px solid #000; background-color: ${subjectColor};">${subject.name}</td>`;
                            }
                            html += `<td class="teacher-cell" style="border-right: 2px solid #000;">${teacher.name}</td>`;

                            DAYS.forEach(day => {
                                periods.forEach(p => {
                                    const item = data.schedule.find(s => 
                                        s.teacherId === teacher.id && 
                                        s.subjectId === subject.id && 
                                        s.day === day && 
                                        s.period === p &&
                                        s.shift === shift
                                    );

                                    if (item) {
                                        const cls = data.classes.find(c => c.id === item.classId);
                                        const r = data.rooms.find(rm => rm.id === item.roomId);
                                        const roomName = r ? r.name : item.roomId;
                                        const room = roomName ? `<sub>${roomName}</sub>` : '';
                                        const dir = item.direction ? ` <span style="font-size:9px">(${item.direction})</span>` : '';
                                        const bgColor = subject.color || '#ffffff';
                                        html += `<td style="border: 1px solid #000; font-weight: bold; background-color: ${bgColor};">${cls ? cls.name : ''}${dir}${room}</td>`;
                                    } else {
                                        html += `<td style="border: 1px solid #000;"></td>`;
                                    }
                                });
                            });
                            html += `</tr>`;
                        });
                        html += `<tr><td colspan="${2 + DAYS.length * periods.length}" style="height: 2px; background-color: #000;"></td></tr>`;
                    });
                    html += `</table><br/><br/>`;
                });

                html += `</body></html>`;
                const blob = new Blob([html], { type: "application/vnd.ms-excel" });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url;
                link.download = `Матрица_Расписания.xls`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const copyForGoogleSheets = () => {
                let tsv = "День\tСмена\tКласс\tУрок\tПредмет\tУчитель\tКабинет\tГруппа\n";
                DAYS.forEach(day => {
                    [Shift.First, Shift.Second].forEach(shift => {
                        const classes = data.classes.filter(c => c.shift === shift);
                        classes.forEach(cls => {
                            SHIFT_PERIODS[shift].forEach(period => {
                                const items = data.schedule.filter(s => s.classId === cls.id && s.day === day && s.shift === shift && s.period === period);
                                items.forEach(item => {
                                    const sub = data.subjects.find(s => s.id === item.subjectId);
                                    const teach = data.teachers.find(t => t.id === item.teacherId);
                                    const r = data.rooms.find(rm => rm.id === item.roomId);
                                    const roomName = r ? r.name : (item.roomId || '');
                                    tsv += `${day}\t${shift}\t${cls.name}\t${period}\t${sub?.name || ''}\t${teach?.name || ''}\t${roomName}\t${item.direction || ''}\n`;
                                });
                            });
                        });
                    });
                });
                navigator.clipboard.writeText(tsv).then(() => {
                    alert("Данные скопированы! Откройте Google Sheets и нажмите Ctrl+V (Cmd+V).");
                });
            };

            const handleDownloadPng = async () => { if (!printRef.current || !window.html2canvas) return; setIsGenerating(true); try { const canvas = await window.html2canvas(printRef.current, { scale: 2, backgroundColor: '#ffffff', logging: false }); const link = document.createElement('a'); link.download = `Замены_${exportDate}.png`; link.href = canvas.toDataURL('image/png'); link.click(); } catch (e) { console.error(e); alert("Ошибка при создании изображения"); } setIsGenerating(false); };
            const subsForDate = data.substitutions.filter(s => s.date === exportDate);
            
            const renderTableForShift = (shift) => {
                const shiftSubs = subsForDate.filter(sub => {
                    const s = data.schedule.find(x => x.id === sub.scheduleItemId);
                    return s && s.shift === shift;
                });
                
                if (shiftSubs.length === 0) return null;

                return (
                    <div className="mb-8">
                        <div className="text-xl font-bold bg-slate-100 text-slate-700 p-2 mb-2 uppercase tracking-wide border-l-4 border-indigo-500">{shift}</div>
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="border-b border-slate-200">
                                    <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-16 text-center">Урок</th>
                                    <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-24">Класс</th>
                                    <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider">Предмет</th>
                                    <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-1/4">Отсутствует</th>
                                    <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-1/4">Заменяет</th>
                                    <th className="py-3 px-2 font-black text-slate-400 text-xs uppercase tracking-wider w-20 text-right">Каб.</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {shiftSubs.map(sub => { 
                                    const s = data.schedule.find(x => x.id === sub.scheduleItemId); 
                                    const cls = data.classes.find(c => c.id === s.classId); 
                                    const subj = data.subjects.find(x => x.id === s.subjectId); 
                                    const t1 = data.teachers.find(t => t.id === sub.originalTeacherId); 
                                    const t2 = data.teachers.find(t => t.id === sub.replacementTeacherId); 
                                    const r = data.rooms.find(rm => rm.id === s.roomId); 
                                    const roomName = r ? r.name : (s.roomId || '—'); 
                                    return (
                                        <tr key={sub.id}>
                                            <td className="py-3 px-2 text-center font-bold text-slate-800 text-lg">{s.period}</td>
                                            <td className="py-3 px-2 font-bold text-slate-700">{cls?.name}</td>
                                            <td className="py-3 px-2"><div className="font-semibold text-slate-800">{subj?.name}</div>{s.direction && <div className="text-[10px] text-slate-500 bg-slate-100 inline-block px-1 rounded mt-0.5">{s.direction}</div>}</td>
                                            <td className="py-3 px-2 text-red-400 line-through text-sm font-medium decoration-red-200">{t1?.name}</td>
                                            <td className="py-3 px-2 text-emerald-700 font-bold text-sm">{t2?.name}</td>
                                            <td className="py-3 px-2 text-right font-mono text-slate-500">{roomName}</td>
                                        </tr>
                                    ) 
                                })}
                            </tbody>
                        </table>
                    </div>
                );
            };

            return (
                <div className="max-w-5xl mx-auto space-y-8 pb-20">
                    <section className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700"><h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><Icon name="Download" className="text-indigo-600 dark:text-indigo-400"/> Резервное копирование</h2><div className="flex flex-wrap gap-4"><button onClick={() => dbService.exportJson(data)} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none flex items-center gap-2"><Icon name="Download" size={20}/> Скачать JSON</button><div className="relative"><input type="file" ref={fileInputRef} onChange={handleImport} accept=".json" className="hidden" /><button onClick={() => fileInputRef.current?.click()} className="px-6 py-3 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 rounded-xl font-bold hover:bg-slate-50 dark:hover:bg-slate-600 transition flex items-center gap-2"><Icon name="Upload" size={20}/> Загрузить JSON</button></div></div></section>
                    <section className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700"><div className="flex flex-col sm:flex-row justify-between items-center gap-6 mb-6"><div><h2 className="text-xl font-bold text-slate-800 dark:text-white flex items-center gap-2"><Icon name="Image" className="text-indigo-600 dark:text-indigo-400"/> Экспорт замен (PNG)</h2></div><div className="flex gap-4 items-center"><input type="date" value={exportDate} onChange={e => setExportDate(e.target.value)} className="border border-slate-200 dark:border-slate-600 p-2 rounded-lg font-bold outline-none focus:border-indigo-500 bg-transparent dark:text-white"/><button onClick={handleDownloadPng} disabled={isGenerating} className="px-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 dark:shadow-none flex items-center gap-2 disabled:opacity-50">{isGenerating ? <><Icon name="Loader" size={20} className="animate-spin"/> Создание...</> : <><Icon name="Download" size={20}/> Скачать PNG</>}</button></div></div><div className="overflow-auto bg-slate-100 dark:bg-slate-900 p-8 rounded-xl border border-slate-200 dark:border-slate-700 flex justify-center"><div ref={printRef} className="bg-white p-8 min-w-[800px] max-w-[1000px] shadow-xl text-slate-900"><div className="flex justify-between items-end border-b-2 border-slate-800 pb-4 mb-6"><div><h1 className="text-3xl font-black uppercase tracking-tight mb-1 text-slate-800">Замена Учителей</h1><p className="text-sm font-bold text-slate-500 uppercase tracking-wider">Гимназия • Официальный документ</p></div><div className="text-right"><div className="text-xs text-slate-400 uppercase font-bold tracking-wider mb-1">Дата</div><div className="text-xl font-bold text-slate-800">{new Date(exportDate).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}</div></div></div>
                        {subsForDate.length === 0 ? (
                            <div className="py-12 text-center border-2 border-dashed border-slate-200 rounded-xl bg-slate-50"><p className="text-slate-400 font-medium italic">Замен на этот день нет</p></div>
                        ) : (
                            <>
                                {renderTableForShift(Shift.First)}
                                {renderTableForShift(Shift.Second)}
                            </>
                        )}
                        <div className="mt-8 pt-4 border-t border-slate-100 flex justify-between items-end text-[10px] text-slate-400"><div>Сформировано автоматически</div><div className="flex flex-col items-end gap-2"><div className="h-px w-32 bg-slate-300"></div><div>Подпись администрации</div></div></div></div></div></section>
                    <section className="bg-white dark:bg-dark-800 p-6 rounded-2xl shadow-sm border border-slate-100 dark:border-slate-700">
                        <h2 className="text-xl font-bold text-slate-800 dark:text-white mb-4 flex items-center gap-2"><Icon name="FileSpreadsheet" className="text-emerald-600 dark:text-emerald-400"/> Экспорт данных</h2>
                        <div className="flex flex-wrap gap-4">
                            <button onClick={exportStyledExcel} className="px-6 py-3 bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-400 border border-emerald-100 dark:border-emerald-900 rounded-xl font-bold hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition flex items-center gap-2"><Icon name="FileSpreadsheet" size={20}/> Скачать Excel (XLS)</button>
                            <button onClick={exportMatrixExcel} className="px-6 py-3 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-400 border border-blue-100 dark:border-blue-900 rounded-xl font-bold hover:bg-blue-100 dark:hover:bg-blue-900/50 transition flex items-center gap-2"><Icon name="Table" size={20}/> Скачать Матрицу (XLS)</button>
                            <button onClick={copyForGoogleSheets} className="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg shadow-green-200 dark:shadow-none flex items-center gap-2"><Icon name="Clipboard" size={20}/> Копировать для Google Sheets</button>
                        </div>
                    </section>
                </div>
            );
        };

        const Layout = () => {
            const [isMobileMenuOpen, setIsMobileMenuOpen] = useState(false);
            const [theme, setTheme] = useState(localStorage.getItem('theme') || 'light');
            const navigate = useNavigate();
            const { isLoading } = useData();
            
            useEffect(() => { if (theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark'); localStorage.setItem('theme', theme); }, [theme]);
            const toggleTheme = () => setTheme(theme === 'light' ? 'dark' : 'light');
            const navItems = [
                { to: '/dashboard', label: 'Рабочий стол', icon: 'Home' }, 
                { to: '/schedule', label: 'Расписание', icon: 'Calendar' }, 
                { to: '/substitutions', label: 'Замены', icon: 'Repeat' }, 
                { to: '/directory', label: 'Справочники', icon: 'BookOpen' }, 
                { to: '/admin', label: 'Администрация', icon: 'Settings' }, 
                { to: '/reports', label: 'Отчеты', icon: 'BarChart2' }, 
                { to: '/export', label: 'Экспорт', icon: 'Download' }
            ];

            if (isLoading) {
                return (
                    <div className="flex h-screen items-center justify-center bg-slate-50 dark:bg-dark-950">
                        <Icon name="Loader" className="animate-spin text-indigo-600" size={48} />
                    </div>
                );
            }

            return (
                <div className="flex h-screen bg-slate-50 dark:bg-dark-950 overflow-hidden transition-colors duration-300">
                    {isMobileMenuOpen && <div className="fixed inset-0 bg-black/20 backdrop-blur-sm z-40 lg:hidden" onClick={() => setIsMobileMenuOpen(false)}/>}
                    <aside className={`fixed lg:static inset-y-0 left-0 z-50 w-64 bg-white dark:bg-dark-800 border-r border-slate-200 dark:border-slate-700 transform transition-all duration-300 ease-in-out ${isMobileMenuOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'} no-print`}>
                        <div className="h-full flex flex-col">
                            <div className="p-6 flex items-center gap-3 border-b border-slate-100 dark:border-slate-700">
                                <div className="bg-indigo-600 p-2.5 rounded-xl text-white shadow-lg shadow-indigo-200 dark:shadow-none"><Icon name="GraduationCap" size={24} strokeWidth={2} /></div>
                                <div><h1 className="text-lg font-black tracking-tight text-slate-800 dark:text-white">Гимназия №22</h1><p className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Менеджер v8.7</p></div>
                                <button className="lg:hidden ml-auto text-slate-400" onClick={() => setIsMobileMenuOpen(false)}><Icon name="X" size={24} /></button>
                            </div>
                            <nav className="flex-1 p-4 space-y-1 overflow-y-auto">
                                {navItems.map((item) => (<NavLink key={item.to} to={item.to} onClick={() => setIsMobileMenuOpen(false)} className={({ isActive }) => `flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold transition-all duration-200 ${isActive ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400 shadow-sm ring-1 ring-indigo-200 dark:ring-transparent' : 'text-slate-500 dark:text-slate-400 hover:bg-slate-50 dark:hover:bg-slate-700 hover:text-slate-900 dark:hover:text-white'}`}><Icon name={item.icon} size={20} strokeWidth={2} />{item.label}</NavLink>))}
                                <div className="pt-4 mt-4 border-t border-slate-100 dark:border-slate-700">
                                    <a href="#/public" target="_blank" className="flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/30 hover:bg-emerald-100 dark:hover:bg-emerald-900/50 transition-all">
                                        <Icon name="Share2" size={20}/> Публичная ссылка
                                    </a>
                                </div>
                            </nav>
                            <StatusWidget />
                            <div className="p-4 border-t border-slate-100 dark:border-slate-700 flex items-center justify-between"><button onClick={toggleTheme} className="flex items-center gap-2 text-xs font-bold text-slate-500 dark:text-slate-400 hover:text-slate-800 dark:hover:text-white transition">{theme === 'light' ? <><Icon name="Moon" size={16}/> Темная тема</> : <><Icon name="Sun" size={16}/> Светлая тема</>}</button></div>
                        </div>
                    </aside>
                    <main className="flex-1 flex flex-col min-w-0 bg-slate-50/50 dark:bg-dark-950">
                        <header className="bg-white/80 dark:bg-dark-800/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-700 lg:hidden sticky top-0 z-30 px-4 py-3 flex items-center justify-between no-print"><div className="flex items-center gap-3"><button onClick={() => setIsMobileMenuOpen(true)} className="p-2 -ml-2 text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg"><Icon name="Menu" size={24} /></button><span className="font-bold text-slate-800 dark:text-white">Меню</span></div></header>
                        <div className="flex-1 overflow-auto p-4 lg:p-8"><Outlet /></div>
                    </main>
                </div>
            );
        };

        const PublicLayout = () => {
            return (
                <div className="min-h-screen bg-slate-50 dark:bg-dark-950 flex flex-col">
                    <header className="bg-white dark:bg-dark-800 border-b border-slate-200 dark:border-slate-700 px-6 py-4 flex items-center justify-between sticky top-0 z-50 no-print">
                        <div className="flex items-center gap-3">
                            <div className="bg-indigo-600 p-2 rounded-lg text-white"><Icon name="GraduationCap" size={24}/></div>
                            <div><h1 className="font-black text-slate-800 dark:text-white text-lg leading-none">Гимназия №22</h1><p className="text-xs font-bold text-slate-400 uppercase">Публичное расписание</p></div>
                        </div>
                        <div className="text-xs font-bold text-emerald-600 bg-emerald-50 dark:bg-emerald-900/30 dark:text-emerald-400 px-3 py-1.5 rounded-full flex items-center gap-2"><Icon name="Eye" size={14}/> Только просмотр</div>
                    </header>
                    <main className="flex-1 p-4 lg:p-8 overflow-auto"><SchedulePage readOnly={true} /></main>
                </div>
            );
        };

        const App = () => {
            return (
                <DataProvider>
                    <HashRouter>
                        <Routes>
                            <Route path="/" element={<Layout />}>
                                <Route index element={<Navigate to="/dashboard" replace />} />
                                <Route path="dashboard" element={<DashboardPage />} />
                                <Route path="schedule" element={<SchedulePage />} />
                                <Route path="substitutions" element={<SubstitutionsPage />} />
                                <Route path="directory" element={<DirectoryPage />} />
                                <Route path="admin" element={<AdminPage />} />
                                <Route path="reports" element={<ReportsPage />} />
                                <Route path="export" element={<ExportPage />} />
                            </Route>
                            <Route path="/public" element={<PublicLayout />} />
                        </Routes>
                    </HashRouter>
                </DataProvider>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
